<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üé™ ENGLISH CIRCUS üé™</title>

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{
      --primary:#ff4757; --secondary:#2ed573; --accent:#ffa502;
      --dark:#2f3542; --light:#ffffff;
    }
    *{font-family:'Nunito',sans-serif; box-sizing:border-box;}
    body{
      margin:0; padding:0;
      background:repeating-linear-gradient(45deg,#fff9c4,#fff9c4 40px,#fff0a5 40px,#fff0a5 80px);
      color:var(--dark); min-height:100vh; padding-bottom:100px;
    }

    /* HEADER */
    .navbar{
      background:var(--light); padding:15px 30px;
      border-bottom:5px solid var(--primary);
      box-shadow:0 10px 20px rgba(0,0,0,.1);
      position:sticky; top:0; z-index:1000;
      display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:20px;
    }
    .brand-area{display:flex; align-items:center; gap:20px;}
    .brand-logo{
      height:120px; width:auto;
      border-radius:15px; border:4px solid var(--dark);
      box-shadow:5px 5px 0 var(--dark); background:white;
    }
    .brand-text{
      font-size:3.1em; font-weight:900; text-transform:uppercase;
      color:var(--primary); letter-spacing:2px;
      text-shadow:3px 3px 0 #000; -webkit-text-stroke:1px white; line-height:1;
    }
    .nav-menu{display:flex; gap:10px; flex-wrap:wrap;}
    .nav-btn{
      padding:10px 18px; border:3px solid var(--dark); border-radius:50px;
      font-weight:900; cursor:pointer; background:var(--light); color:var(--dark);
      transition:.2s; font-size:1em; text-transform:uppercase; box-shadow:0 5px 0 var(--dark);
      user-select:none;
    }
    .nav-btn:active{transform:translateY(4px); box-shadow:none;}
    .nav-btn.active{background:var(--primary); color:white; border-color:#c0392b; box-shadow:0 5px 0 #c0392b;}

    .container{max-width:1400px; margin:30px auto; padding:0 20px;}
    .tab-content{display:none; animation:popIn .25s;}
    .tab-content.active{display:block;}
    @keyframes popIn{from{opacity:0; transform:scale(.99);} to{opacity:1; transform:scale(1);} }

    /* SPECIAL SECTION */
    .special-section{
      display:grid; grid-template-columns:1fr 2.5fr;
      gap:30px; margin-bottom:18px;
      align-items:stretch;
    }
    @media (max-width:900px){ .special-section{grid-template-columns:1fr;} }

    /* TEACHER (R·∫†P TR∆Ø·ªûNG) */
    .teacher-card{
      background:linear-gradient(135deg,#2c3e50,#000);
      color:white; text-align:center; border:5px solid #f1c40f;
      border-radius:20px; padding:20px; position:relative; overflow:hidden;
      box-shadow:0 10px 20px rgba(0,0,0,.3); cursor:pointer;
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      min-height:260px;
    }
    .teacher-card::before{
      content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%;
      background:repeating-conic-gradient(from 0deg,transparent 0deg 20deg,rgba(255,215,0,.1) 20deg 40deg);
      animation:spin-universe 20s linear infinite; z-index:1;
      pointer-events:none;
    }
    @keyframes spin-universe{from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    .universe-frame{
      width:120px; height:120px; margin-bottom:10px; border-radius:50%;
      border:5px solid #f1c40f; background:white;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden; position:relative; z-index:2;
      box-shadow:0 10px 0 rgba(0,0,0,.2);
    }
    .universe-frame img{width:100%; height:100%; object-fit:cover;}
    .universe-badge{
      background:#f1c40f; color:#000; padding:5px 15px; border-radius:20px; font-weight:900;
      text-transform:uppercase; position:relative; z-index:2; animation:pulse 2s infinite; display:inline-block;
    }
    @keyframes pulse{0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

    /* FEATURED (G∆Ø∆†NG M·∫∂T TI√äU BI·ªÇU) */
    .featured-wrapper{
      background:linear-gradient(135deg,#ff9ff3,#feca57);
      border:5px solid white; border-radius:20px;
      padding:18px 15px 12px;
      position:relative; box-shadow:0 10px 0 rgba(0,0,0,.1);
      min-height:260px;
    }
    .featured-title{
      background:white; color:var(--primary); padding:7px 22px; border-radius:999px;
      font-weight:900; position:absolute; top:-16px; left:50%; transform:translateX(-50%);
      box-shadow:0 6px 0 rgba(0,0,0,.12);
      white-space:nowrap; z-index:50; font-size:1.15em;
      border:3px solid rgba(0,0,0,.08);
    }
    .featured-list{
      display:flex; gap:16px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:stretch;
      padding:46px 10px 10px;
    }
    .f-card{
      background:white;
      width: min(220px, 100%);
      padding:14px; border-radius:18px; text-align:center;
      border:5px solid var(--primary);
      box-shadow:7px 7px 0 rgba(0,0,0,.12);
      position:relative; overflow:hidden;
      flex: 0 1 220px;
    }
    .f-card::before{
      content:''; position:absolute; inset:-40%;
      background:conic-gradient(from 0deg,rgba(255,255,255,0),rgba(255,255,255,.55),rgba(255,255,255,0));
      animation:shine 3.5s linear infinite;
      pointer-events:none;
    }
    @keyframes shine{to{transform:rotate(360deg);} }
    .f-inner{position:relative; z-index:2;}
    .f-topline{display:flex; align-items:center; justify-content:center; gap:10px;}
    .f-rankpill{
      font-weight:900; font-size:.8em; padding:4px 10px; border-radius:999px;
      border:2px solid rgba(0,0,0,.15);
      background:rgba(255,255,255,.92);
    }
    .f-points{
      font-weight:900; font-size:1.05em; color:#fff; padding:7px 12px; border-radius:12px;
      box-shadow:0 6px 0 rgba(0,0,0,.15); display:inline-block; margin-top:8px;
    }
    .f-reason{
      background:var(--primary); color:white; font-size:.85em; padding:4px 10px; border-radius:10px;
      margin-top:10px; display:inline-block; font-weight:900;
    }
    .f-subbtn{
      font-size:.86em;
      padding:6px 10px;
      box-shadow:0 4px 0 rgba(0,0,0,.12);
      border-width:2px;
      opacity:.92;
    }

    /* DASH CONTROLS */
    .dash-controls{
      display:flex; gap:10px; margin:10px 0 14px; flex-wrap:wrap;
      background:rgba(255,255,255,.88);
      border:2px solid rgba(0,0,0,.08);
      padding:10px; border-radius:16px;
      backdrop-filter: blur(4px);
      position:relative;
      z-index:300;
    }

    /* ‚úÖ STUDENT GRID (NH·ªé L·∫†I + 1 H√ÄNG 5 HS) */
    .student-grid{
      display:grid;
      grid-template-columns:repeat(5, minmax(0, 1fr));
      gap:18px;
      margin-top:18px;
      position:relative;
      z-index:1;
    }
    @media (max-width:1300px){ .student-grid{grid-template-columns:repeat(4, minmax(0,1fr));} }
    @media (max-width:1080px){ .student-grid{grid-template-columns:repeat(3, minmax(0,1fr));} }
    @media (max-width:820px){  .student-grid{grid-template-columns:repeat(2, minmax(0,1fr));} }
    @media (max-width:520px){  .student-grid{grid-template-columns:1fr;} }

    /* CARD (NH·ªé L·∫†I) */
    .card{
      background:white; border-radius:22px;
      padding:14px 14px 70px;
      text-align:center; position:relative;
      box-shadow:0 12px 0 rgba(0,0,0,.1);
      border:5px solid #eee; transition:.3s;
      background-image:linear-gradient(to bottom,#fff,#f9f9f9);
      cursor:pointer;
      overflow:visible;
      height:360px;
    }
    .card:hover{transform:translateY(-8px);}

    .rank-frame{
      width:104px; height:104px;
      margin:-24px auto 8px;
      border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:58px; position:relative; background:white; z-index:2;
      box-shadow:0 10px 20px rgba(0,0,0,.15); overflow:visible;
      --rcol:#999; --rcolrgb: 153,153,153;
    }
    .rank-frame::after{
      content:'';
      position:absolute;
      inset:-12px;
      border-radius:50%;
      background:radial-gradient(circle,
        rgba(var(--rcolrgb),0.50) 0%,
        rgba(var(--rcolrgb),0.22) 35%,
        rgba(var(--rcolrgb),0.00) 70%
      );
      filter: blur(10px);
      z-index:-1;
      pointer-events:none;
    }
    .rank-frame::before{
      content:'';
      position:absolute;
      inset:-2px;
      border-radius:50%;
      box-shadow:
        0 0 0 6px rgba(var(--rcolrgb),0.16),
        0 0 22px rgba(var(--rcolrgb),0.45),
        0 0 46px rgba(var(--rcolrgb),0.22);
      z-index:-1;
      pointer-events:none;
    }

    .rank-frame img{width:100%; height:100%; object-fit:cover; border-radius:50%;}
    .rank-badge{
      position:absolute; top:-14px; right:-10px;
      padding:5px 14px; color:white; font-weight:900; font-size:.78em;
      border-radius:20px; text-transform:uppercase; z-index:6;
      box-shadow:2px 2px 0 rgba(0,0,0,.2); transform:rotate(10deg);
    }
    .rank-bronze{border:8px solid #cd7f32; background:#fff0e6;}
    .rank-silver{border:8px solid #b2bec3; background:#f1f2f6;}
    .rank-gold{border:8px solid #f1c40f; background:#fffbf0;}
    .rank-platinum{border:8px solid #0fb9b1; background:#dff9fb;}
    .rank-emerald{border:8px solid #2ecc71; background:#daffdf;}
    .rank-diamond{border:8px solid #a55eea; background:#f3e5f5;}

    .card-aura::before{
      content:''; position:absolute; top:-10px; left:-10px; right:-10px; bottom:-10px;
      background:linear-gradient(45deg,#ff00cc,#3333ff,#00ffcc);
      border-radius:35px; z-index:-1; filter:blur(15px); opacity:.6; animation:spin-aura 4s linear infinite;
      pointer-events:none;
    }
    @keyframes spin-aura{0%{opacity:.5;} 50%{opacity:.8;} 100%{opacity:.5;} }

    .rank-icon-float{
      position:absolute; top:-30px; left:50%; transform:translateX(-50%);
      font-size:30px; animation:float 2s ease-in-out infinite; z-index:7;
      text-shadow:0 6px 16px rgba(0,0,0,.25);
      pointer-events:none;
    }
    @keyframes float{0%,100%{transform:translate(-50%,0);} 50%{transform:translate(-50%,-10px);} }

    .card-score{
      font-size:2.05em; font-weight:900; color:var(--dark); text-shadow:2px 2px 0 #eee; margin:8px 0;
    }

    .title-slot{
      min-height:52px;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:4px;
    }
    .stu-name{
      margin:8px 0 4px;
      font-weight:900;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:44px;
      font-size:1.02em;
    }

    /* toolbar */
    .card-actions{
      position:absolute;
      bottom:10px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; z-index:8;
      background:rgba(255,255,255,.92);
      padding:6px 10px;
      border:2px solid rgba(0,0,0,.08);
      border-radius:999px;
      box-shadow:0 8px 18px rgba(0,0,0,.08);
      backdrop-filter: blur(4px);
    }
    .icon-btn{
      width:30px; height:30px;
      background:#f2f2f2; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; transition:.2s;
      border:2px solid #ddd;
      font-size:.92em;
    }
    .icon-btn:hover{transform:scale(1.10);}
    .edit-btn{color:#2980b9;} .del-btn{color:#c0392b;}
    .star-btn{color:#ccc;} .star-btn.active{background:#f1c40f; color:white; border-color:#f39c12;}

    /* TABLES + INPUT */
    .live-table{width:100%; border-collapse:separate; border-spacing:0 10px;}
    .live-table th{background:var(--dark); color:white; padding:14px; border-radius:10px; text-transform:uppercase;}
    .live-table td{background:white; padding:10px; border:2px solid #eee; border-radius:10px; vertical-align:middle;}
    .form-control{
      width:100%; padding:12px; border:3px solid #b2bec3; border-radius:12px;
      font-size:1.05em; margin-bottom:10px; font-weight:800;
    }

    /* nh·∫≠t k√Ω: n√∫t ¬± nh·ªè */
    .btn-point{
      width:34px; height:30px;
      border:none; border-radius:9px; font-weight:900;
      cursor:pointer; color:white;
      box-shadow:0 3px 0 rgba(0,0,0,.18);
      margin:0 2px;
      font-size:.88em;
    }
    .btn-point:active{transform:translateY(3px); box-shadow:none;}
    .bg-red{background:#ff6b6b;} .bg-green{background:#1dd1a1;}
    .bg-red-dark{background:#ee5253;} .bg-green-dark{background:#10ac84;}

    /* TITLES */
    .title-banner{
      text-align:center; padding:16px 18px; border-radius:20px; margin:0 auto 18px;
      border:4px solid rgba(0,0,0,.18);
      box-shadow:0 10px 0 rgba(0,0,0,.12);
      background:linear-gradient(135deg,
        rgba(255,71,87,.74),
        rgba(255,165,2,.74),
        rgba(46,213,115,.74),
        rgba(55,66,250,.74)
      );
    }
    .mega-title{
      text-align:center; font-size:2.9em; font-weight:900; text-transform:uppercase; margin:0;
      background:linear-gradient(to right,#ff4757,#ffa502,#2ed573,#3742fa);
      -webkit-background-clip:text; color:transparent;
      -webkit-text-stroke:2px rgba(255,255,255,.92);
      text-shadow:4px 4px 0 rgba(0,0,0,.25);
    }
    .hint{font-size:.92em; color:rgba(255,255,255,.92); font-weight:900; text-shadow:2px 2px 0 rgba(0,0,0,.18); margin-top:8px;}

    /* DROPDOWN ICON */
    .custom-select-wrapper{position:relative; width:100%; margin-bottom:20px; user-select:none;}
    .custom-select-trigger{
      display:flex; align-items:center; justify-content:space-between;
      padding:15px; background:#fff; border:3px solid #b2bec3; border-radius:12px; cursor:pointer; font-weight:900;
    }
    .custom-options{
      position:absolute; top:100%; left:0; right:0; background:#fff; border:3px solid #b2bec3;
      z-index:999; max-height:250px; overflow-y:auto; display:none;
      box-shadow:0 10px 20px rgba(0,0,0,.2); border-radius:0 0 10px 10px;
    }
    .custom-select-wrapper.open .custom-options{display:block;}
    .option-group-label{padding:10px; background:#eee; font-weight:900; color:var(--primary);}
    .custom-option{padding:10px; cursor:pointer; display:flex; align-items:center; border-bottom:1px solid #eee;}
    .custom-option:hover{background:#f0f0f0;}
    .opt-icon{font-size:24px; margin-right:10px; width:30px; text-align:center;}

    /* MODALS */
    .modal{
      display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,.7); align-items:center; justify-content:center;
      backdrop-filter:blur(5px);
    }
    .modal-content{
      background:white; width:95%; max-width:600px; padding:30px; border-radius:25px;
      max-height:90vh; overflow-y:auto; border:5px solid var(--dark); position:relative;
    }
    .close-btn{position:absolute; right:20px; top:15px; font-size:24px; cursor:pointer;}

    .stat-card{
      background:white; padding:20px; border-radius:15px;
      border-left:5px solid var(--primary);
      box-shadow:0 5px 15px rgba(0,0,0,.05); text-align:center;
    }
    .stat-val{font-size:2.5em; font-weight:900; color:var(--dark); display:block;}
    .report-body{display:grid; grid-template-columns:2fr 1fr; gap:20px;}
    @media(max-width:900px){ .report-body{grid-template-columns:1fr;} }

    /* ====== TEST (KI·ªÇM TRA) ====== */
    .test-wrap{
      background:white; padding:20px; border-radius:20px; border:3px solid var(--dark);
    }
    .test-grid{
      display:grid; grid-template-columns: 1fr 1.2fr; gap:18px;
      align-items:start;
    }
    @media(max-width:980px){ .test-grid{grid-template-columns:1fr;} }

    /* ‚úÖ tinh t·∫ø h∆°n: ph√¢n c·∫•p ch·ªØ (ch·ªâ d√πng trong tab Ki·ªÉm Tra) */
    .test-header{
      display:flex; flex-direction:column; gap:6px;
      text-align:center; margin-bottom:14px;
    }
    .test-title{
      margin:0;
      font-size:2.0em;
      font-weight:900;
      color:var(--primary);
      letter-spacing:.2px;
      text-transform:none;
    }
    .test-subtitle{
      margin:0;
      font-weight:900;
      color:#6b7280;
      font-size:.95em;
    }
    .field-label{
      font-weight:900;
      color:var(--primary);
      font-size:.95em;
      letter-spacing:.2px;
    }
    .help-text{
      font-weight:900;
      color:#6b7280;
      font-size:.9em;
    }
    .pill{
      display:inline-block; padding:6px 12px; border-radius:999px;
      font-weight:900; border:2px solid rgba(0,0,0,.12);
      background:rgba(255,255,255,.9);
    }
    .mini-stat{
      display:grid; grid-template-columns: repeat(3, minmax(120px, 1fr));
      gap:10px; margin-top:10px;
    }
    @media(max-width:520px){ .mini-stat{grid-template-columns:1fr;} }
    .mini-stat .stat-card{padding:14px;}
    .mini-stat .stat-val{font-size:1.8em;}
    .tag-w{
      font-weight:900; padding:4px 10px; border-radius:12px;
      background:#f1f2f6; border:2px solid rgba(0,0,0,.08);
      display:inline-block;
    }
    .btn-danger{
      background:#c0392b !important; color:white !important; border-color:#c0392b !important;
    }
    .btn-info{
      background:#2980b9 !important; color:white !important; border-color:#2980b9 !important;
    }
    .btn-ok{
      background:var(--primary) !important; color:white !important; border-color:var(--primary) !important;
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="brand-area">
      <img src="English.jpg" alt="Logo" class="brand-logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3799/3799963.png'">
      <div class="brand-text">G√ÅNH XI·∫æC<br>ENGLISH</div>
    </div>
    <div class="nav-menu">
      <button id="btn-dashboard" class="nav-btn active" onclick="switchTab('dashboard')">ƒê·∫°i S·∫£nh</button>
      <button id="btn-input" class="nav-btn" onclick="switchTab('input')">Nh·∫≠t K√Ω</button>
      <button id="btn-test" class="nav-btn" onclick="switchTab('test')">Ki·ªÉm Tra</button>
      <button id="btn-wheel" class="nav-btn" onclick="switchTab('wheel')">V√≤ng Quay</button>
      <button id="btn-report" class="nav-btn" onclick="switchTab('report')">B√°o C√°o</button>
      <button class="nav-btn" onclick="exportExcel()" style="background:#20bf6b; color:white; border-color:#20bf6b">
        <i class="fas fa-file-excel"></i> Excel
      </button>
    </div>
  </nav>

  <div class="container">

    <!-- DASHBOARD -->
    <div id="tab-dashboard" class="tab-content active">
      <div class="special-section">
        <div class="teacher-card" onclick="openTeacherModal()">
          <div style="position:absolute; top:10px; right:10px; opacity:0.7; z-index:3"><i class="fas fa-pen"></i></div>
          <div class="universe-frame" id="tAvatarDisplay"></div>
          <div class="universe-badge">üëë K·∫ª n·∫Øm gi·ªØ z≈© tr·ª• üëë</div>
          <h2 id="tNameDisplay" style="margin-top:10px; text-transform:uppercase; text-shadow:2px 2px 0 #000; position:relative; z-index:2"></h2>
        </div>

        <div class="featured-wrapper">
          <div class="featured-title">üåü G∆Ø∆†NG M·∫∂T TI√äU BI·ªÇU</div>
          <div class="featured-list" id="featuredList"></div>
        </div>
      </div>

      <div class="dash-controls">
        <input type="text" id="searchName" class="form-control" placeholder="üîç T√¨m t√™n..." style="width:220px; margin:0" onkeyup="renderDashboard()">
        <select id="filterClass" class="form-control" style="width:auto; margin:0" onchange="renderDashboard()"></select>

        <select id="sortType" class="form-control" style="width:auto; margin:0" onchange="renderDashboard()">
          <option value="points">S·∫Øp x·∫øp: ƒêi·ªÉm</option>
          <option value="name">S·∫Øp x·∫øp: T√™n</option>
          <option value="rank">S·∫Øp x·∫øp: H·∫°ng</option>
        </select>

        <button class="nav-btn" style="background:var(--primary); color:white; margin-left:auto" onclick="openAddModal()">+ Th√™m B√©</button>
      </div>

      <div id="studentGrid" class="student-grid"></div>
    </div>

    <!-- INPUT / LOGS -->
    <div id="tab-input" class="tab-content">
      <div style="background:white; padding:20px; border-radius:20px; border:3px solid var(--dark)">
        <h2 style="text-align:center; color:var(--primary); margin-top:0">üìù NH·∫¨T K√ù L√äN L·ªöP</h2>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:12px">
          <div>
            <label style="font-weight:900; color:var(--primary)">üìÖ Ng√†y & L·ªõp:</label>
            <div style="display:flex; gap:10px; margin-top:5px">
              <input type="date" id="inputDate" class="form-control" style="margin:0">
              <select id="inputClass" class="form-control" onchange="startSession()" style="margin:0">
                <option value="">-- Ch·ªçn l·ªõp --</option>
              </select>
            </div>
          </div>
          <div>
            <label style="font-weight:900; color:var(--primary)">üìñ N·ªôi dung b√†i:</label>
            <input type="text" id="inputContent" class="form-control" placeholder="V√≠ d·ª•: Unit 1..." style="margin-top:5px">
          </div>
        </div>

        <div style="margin-bottom:18px">
          <label style="font-weight:900; color:var(--primary)">üì£ D·∫∑n d√≤ chung:</label>
          <input type="text" id="inputGeneralNote" class="form-control" placeholder="V√≠ d·ª•: L√†m b√†i t·∫≠p..." style="margin-top:5px">
        </div>

        <div id="liveArea" style="display:none; border-top: 3px dashed #eee; padding-top:16px">
          <div style="max-height: 500px; overflow-y:auto; border: 2px solid #eee; border-radius: 12px;">
            <table class="live-table">
              <thead>
                <tr>
                  <th style="width:30%">H·ªçc Sinh</th>
                  <th style="width:50%; text-align:center">ƒêi·ªÉm (¬±10)</th>
                  <th style="width:20%">Ghi ch√∫ ri√™ng</th>
                </tr>
              </thead>
              <tbody id="studentLiveRows"></tbody>
            </table>
          </div>
          <button class="nav-btn" style="width:100%; background:var(--primary); color:white; font-size:1.15em; margin-top:16px" onclick="finishSession()">
            üíæ L∆∞u Nh·∫≠t K√Ω
          </button>
        </div>

        <hr style="margin:22px 0; border:none; border-top:3px dashed #eee">

        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <h3 style="margin:0; color:var(--dark)">üìö L·ªäCH S·ª¨ NH·∫¨T K√ù</h3>
          <button class="nav-btn" style="margin-left:auto" onclick="renderLogs()">üîÑ T·∫£i l·∫°i</button>
          <button class="nav-btn" style="background:#ff4757; color:white; border-color:#ff4757" onclick="clearAllLogs()">üóëÔ∏è X√≥a t·∫•t c·∫£</button>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
          <select id="logFilterClass" class="form-control" style="width:auto; margin:0" onchange="renderLogs()"></select>
          <input type="month" id="logFilterMonth" class="form-control" style="width:auto; margin:0" onchange="renderLogs()">
          <select id="logSort" class="form-control" style="width:auto; margin:0" onchange="renderLogs()">
            <option value="desc">Ng√†y: m·ªõi ‚Üí c≈©</option>
            <option value="asc">Ng√†y: c≈© ‚Üí m·ªõi</option>
          </select>
        </div>

        <div style="overflow:auto; border:2px solid #eee; border-radius:12px; background:white">
          <table class="live-table" style="border-spacing:0 10px; min-width:980px">
            <thead>
              <tr>
                <th style="width:160px">Ng√†y</th>
                <th style="width:140px">L·ªõp</th>
                <th>N·ªôi dung</th>
                <th style="width:220px">Ghi ch√∫ chung</th>
                <th style="width:300px">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="logsRows"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚úÖ TEST / KI·ªÇM TRA -->
    <div id="tab-test" class="tab-content">
      <div class="test-wrap">

        <div class="test-header">
          <h2 class="test-title">ƒêI·ªÇM KI·ªÇM TRA</h2>
          <p class="test-subtitle">C·ªê G·∫ÆNG M·ªñI NG√ÄY N√ÄO</p>
        </div>

        <div class="test-grid">
          <!-- LEFT: INPUT -->
          <div style="background:rgba(255,255,255,.9); border:2px solid rgba(0,0,0,.08); border-radius:16px; padding:14px">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
              <span class="pill">üìå Nh·∫≠p ƒëi·ªÉm</span>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px">
              <div>
                <label class="field-label">L·ªõp</label>
                <select id="testClass" class="form-control" style="margin-bottom:0" onchange="testPopulateStudents()">
                  <option value="">-- Ch·ªçn l·ªõp --</option>
                </select>
              </div>
              <div>
                <label class="field-label">H·ªçc sinh</label>
                <select id="testStudent" class="form-control" style="margin-bottom:0" onchange="renderTestSummary()">
                  <option value="">-- Ch·ªçn h·ªçc sinh --</option>
                </select>
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
              <div>
                <label class="field-label">Ng√†y ki·ªÉm tra</label>
                <input type="date" id="testDate" class="form-control" style="margin-bottom:0">
              </div>
              <div>
                <label class="field-label">T√™n b√†i</label>
                <input type="text" id="testName" class="form-control" style="margin-bottom:0" placeholder="VD: 15p Unit 3">
              </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:10px">
              <div>
                <label class="field-label">ƒêi·ªÉm</label>
                <input type="number" id="testScore" class="form-control" style="margin-bottom:0" min="0" max="10" step="0.1" placeholder="0 ‚Üí 10">
              </div>
              <div>
                <label class="field-label">H·ªá s·ªë</label>
                <select id="testWeight" class="form-control" style="margin-bottom:0">
                  <option value="1">H·ªá s·ªë 1</option>
                  <option value="2">H·ªá s·ªë 2</option>
                  <option value="3">H·ªá s·ªë 3</option>
                </select>
              </div>
              <div>
                <label class="field-label">Ghi ch√∫</label>
                <input type="text" id="testNote" class="form-control" style="margin-bottom:0" placeholder="Tu·ª≥ ch·ªçn">
              </div>
            </div>

            <button class="nav-btn btn-ok" style="width:100%; margin-top:12px" onclick="addTestScore()">
              ‚ûï L∆∞u b√†i ki·ªÉm tra
            </button>

            <button class="nav-btn btn-danger" style="width:100%; margin-top:10px" onclick="deleteAllTestsOfStudent()">
              üóëÔ∏è X√≥a to√†n b·ªô ƒëi·ªÉm ki·ªÉm tra
            </button>
          </div>

          <!-- RIGHT: SUMMARY + LIST -->
          <div style="background:rgba(255,255,255,.9); border:2px solid rgba(0,0,0,.08); border-radius:16px; padding:14px">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
              <span class="pill">üìà ƒêi·ªÉm trung b√¨nh</span>
              <span class="help-text">T√≠nh theo: Œ£(ƒëi·ªÉm √ó h·ªá s·ªë) / Œ£(h·ªá s·ªë)</span>
            </div>

            <div class="mini-stat" id="testMiniStat"></div>

            <div style="margin-top:14px; overflow:auto; border:2px solid #eee; border-radius:12px; background:white">
              <table class="live-table" style="border-spacing:0 10px; min-width:900px">
                <thead>
                  <tr>
                    <th style="width:130px">Ng√†y</th>
                    <th>T√™n b√†i</th>
                    <th style="width:110px; text-align:center">ƒêi·ªÉm</th>
                    <th style="width:110px; text-align:center">H·ªá s·ªë</th>
                    <th style="width:220px">Ghi ch√∫</th>
                    <th style="width:180px; text-align:center">H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="testRows">
                  <tr><td colspan="6" style="background:white">Ch·ªçn l·ªõp + h·ªçc sinh ƒë·ªÉ xem.</td></tr>
                </tbody>
              </table>
            </div>

            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
              <button class="nav-btn btn-info" onclick="openTestEditModal()">‚úèÔ∏è S·ª≠a nhanh</button>
              <button class="nav-btn" onclick="renderTestRanking()">üèÜ X·∫øp h·∫°ng ƒëi·ªÉm</button>
            </div>

            <div id="testRankingBox" style="margin-top:12px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- (PH·∫¶N 2/3 s·∫Ω ti·∫øp t·ª•c: WHEEL + REPORT + to√†n b·ªô MODALS) -->
    <!-- WHEEL -->
    <div id="tab-wheel" class="tab-content">
      <div class="title-banner">
        <h1 class="mega-title">üé° V√íNG QUAY NH√ÇN PH·∫®M üé°</h1>
        <div class="hint">Ng·∫´u nhi√™n thui n√†oooo</div>
      </div>

      <div style="text-align:center; background:#f3e5f5; border:4px solid #8e44ad; padding:20px; border-radius:20px">
        <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap">
          <div style="width:320px; text-align:left">
            <select id="wheelClassSelect" class="form-control" onchange="populateWheelList()" style="margin-bottom:8px">
              <option value="">-- Ch·ªçn l·ªõp --</option>
            </select>
            <textarea id="wheelNamesList" class="form-control" rows="10" placeholder="Danh s√°ch t√™n..."></textarea>
            <button class="nav-btn" style="width:100%; background:#8e44ad; color:white;" onclick="updateWheelFromList()">C·∫≠p nh·∫≠t</button>
          </div>

          <div style="flex:1; text-align:center; min-width:320px">
            <button id="spinBtn" class="nav-btn" style="background:#2ecc71; color:white; font-size:1.25em; margin-bottom:16px" onclick="spinWheel()" disabled>
              üéØ Quay
            </button>
            <div style="position:relative; width:92%; max-width:520px; margin:0 auto">
              <div style="position:absolute; top:50%; right:-18px; transform:translateY(-50%); border-top:22px solid transparent; border-bottom:22px solid transparent; border-right:36px solid #ff4757; z-index:10"></div>
              <canvas id="wheelCanvas" width="520" height="520" style="width:100%; box-shadow:0 10px 0 rgba(0,0,0,0.12); border-radius:50%; border:5px solid rgba(0,0,0,.1)"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- REPORT -->
    <div id="tab-report" class="tab-content">
      <h2 style="text-align:center; margin-top:0">üìä B√ÅO C√ÅO</h2>
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:30px" id="reportStats"></div>
      <div class="report-body">
        <div style="background:white; padding:20px; border-radius:20px; border:3px solid var(--dark)">
          <canvas id="classChart"></canvas>
        </div>
        <div style="background:white; padding:20px; border-radius:20px; border:3px solid var(--dark)">
          <h4 style="margin-top:0">üöÄ Top X·∫øp H·∫°ng</h4>
          <ul id="growthList" style="list-style:none; padding:0; margin:0"></ul>
        </div>
      </div>
    </div>

  </div>

  <!-- FEATURE PROMPT MODAL -->
  <div id="featurePromptModal" class="modal">
    <div class="modal-content" style="max-width:560px; text-align:center">
      <h3 style="margin-top:0">VINH DANH H·ªåC SINH</h3>
      <p style="margin-top:0">Danh hi·ªáu c√≥ th·ªùi h·∫°n: ch·ªçn <b>ng√†y b·∫Øt ƒë·∫ßu</b> & <b>ng√†y k·∫øt th√∫c</b> ƒë·ªÉ t·ª± ‚Äúh·∫øt h·∫°n‚Äù.</p>

      <input type="hidden" id="featId">
      <input type="text" id="featReason" class="form-control" placeholder="Danh hi·ªáu (b·∫Øt bu·ªôc)">

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div>
          <label style="font-weight:900; color:var(--primary)">Ng√†y b·∫Øt ƒë·∫ßu</label>
          <input type="date" id="featStart" class="form-control" style="margin-bottom:0">
        </div>
        <div>
          <label style="font-weight:900; color:var(--primary)">Ng√†y k·∫øt th√∫c</label>
          <input type="date" id="featEnd" class="form-control" style="margin-bottom:0">
        </div>
      </div>

      <input type="text" id="featNote" class="form-control" placeholder="Ghi ch√∫ (tu·ª≥ ch·ªçn)">
      <button class="nav-btn" style="background:var(--primary); color:white; width:100%" onclick="confirmFeature()">X√°c nh·∫≠n</button>
      <button class="nav-btn" style="width:100%; margin-top:10px" onclick="closeModal('featurePromptModal')">ƒê√≥ng</button>
    </div>
  </div>

  <!-- TITLE EDIT MODAL -->
  <div id="titleEditModal" class="modal" style="z-index:3700">
    <div class="modal-content" style="max-width:560px">
      <span class="close-btn" onclick="closeModal('titleEditModal')">&times;</span>
      <h2 style="margin-top:0; color:var(--primary)">‚úèÔ∏è Ch·ªânh s·ª≠a danh hi·ªáu</h2>

      <input type="hidden" id="editStuId">
      <input type="hidden" id="editTitleId">

      <label style="font-weight:900; color:var(--primary)">Danh hi·ªáu</label>
      <input type="text" id="editTitleText" class="form-control" placeholder="VD: Ong ChƒÉm Ch·ªâ...">

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
        <div>
          <label style="font-weight:900; color:var(--primary)">Ng√†y b·∫Øt ƒë·∫ßu</label>
          <input type="date" id="editStart" class="form-control" style="margin-bottom:0">
        </div>
        <div>
          <label style="font-weight:900; color:var(--primary)">Ng√†y k·∫øt th√∫c</label>
          <input type="date" id="editEnd" class="form-control" style="margin-bottom:0">
        </div>
      </div>

      <label style="font-weight:900; color:var(--primary)">Ghi ch√∫</label>
      <input type="text" id="editNote" class="form-control" placeholder="Tu·ª≥ ch·ªçn">

      <button class="nav-btn" style="width:100%; background:var(--primary); color:white" onclick="saveTitleEdit()">L∆∞u thay ƒë·ªïi</button>
    </div>
  </div>

  <!-- STUDENT MODAL -->
  <div id="studentModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('studentModal')">&times;</span>
      <h2 id="modalTitle" style="color:var(--primary)">H·ªí S∆† H·ªåC SINH</h2>
      <input type="hidden" id="stuId">
      <input type="text" id="stuName" class="form-control" placeholder="T√™n b√©">
      <div style="display:flex; gap:10px">
        <input type="text" id="stuClass" class="form-control" placeholder="L·ªõp">
        <input type="number" id="stuPoints" class="form-control" placeholder="ƒêi·ªÉm">
      </div>
      <input type="text" id="stuGift" class="form-control" placeholder="Qu√† mong mu·ªën">

      <label style="font-weight:900">Ch·ªçn Avatar (C√≥ m√¥ t·∫£):</label>
      <div class="custom-select-wrapper" id="avatarWrapper">
        <div class="custom-select-trigger" onclick="toggleAvatarDropdown(event)">
          <span id="avatarTriggerText">üê∂ Ch·ªçn Avatar...</span> <i class="fas fa-chevron-down"></i>
        </div>
        <div class="custom-options" id="avatarOptions"></div>
        <input type="hidden" id="stuSelectedAvatar" value="üê∂">
      </div>

      <label style="margin-top:10px; display:block; font-weight:900">Ho·∫∑c upload ·∫£nh:</label>
      <input type="file" id="stuImageFile" accept="image/*" class="form-control">

      <button class="nav-btn" style="width:100%; background:var(--primary); color:white; margin-top:10px" onclick="saveStudent()">L∆∞u l·∫°i</button>
    </div>
  </div>

  <!-- TEACHER MODAL -->
  <div id="teacherModal" class="modal">
    <div class="modal-content" style="max-width:420px">
      <span class="close-btn" onclick="closeModal('teacherModal')">&times;</span>
      <h2 style="margin-top:0">S·ª¨A H·ªí S∆† R·∫†P TR∆Ø·ªûNG</h2>
      <input type="text" id="tNameInput" class="form-control" placeholder="T√™n hi·ªÉn th·ªã">
      <input type="file" id="tImageFile" accept="image/*" class="form-control">
      <button class="nav-btn" style="width:100%; background:var(--primary); color:white; margin-top:10px" onclick="saveTeacher()">L∆∞u</button>
    </div>
  </div>

  <!-- WINNER MODAL -->
  <div id="winnerModal" class="modal" style="z-index:3000">
    <div class="modal-content" style="text-align:center; border-color:#f1c40f; max-width:520px">
      <span class="close-btn" onclick="closeModal('winnerModal')">&times;</span>
      <h2 style="color:#e67e22; font-size:2.6em; margin-top:0">üéâ CHI·∫æN TH·∫ÆNG! üéâ</h2>
      <div id="winnerDisplay" style="font-size:100px; margin:12px 0 10px"></div>
      <h1 id="winnerName" style="color:var(--primary); text-transform:uppercase; margin:0"></h1>
    </div>
  </div>

  <!-- LOG DETAIL MODAL -->
  <div id="logDetailModal" class="modal" style="z-index:3500">
    <div class="modal-content" style="max-width:980px">
      <span class="close-btn" onclick="closeModal('logDetailModal')">&times;</span>
      <h2 style="margin-top:0; color:var(--primary)">üßæ CHI TI·∫æT NH·∫¨T K√ù</h2>
      <div id="logDetailBody"></div>
    </div>
  </div>

  <!-- LOG EDIT MODAL -->
  <div id="logEditModal" class="modal" style="z-index:3550">
    <div class="modal-content" style="max-width:980px">
      <span class="close-btn" onclick="closeModal('logEditModal')">&times;</span>
      <h2 style="margin-top:0; color:var(--primary)">‚úèÔ∏è S·ª¨A L·ªäCH S·ª¨ D·∫†Y</h2>

      <input type="hidden" id="editLogId">

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px">
        <div>
          <label style="font-weight:900; color:var(--primary)">Ng√†y</label>
          <input type="date" id="editLogDate" class="form-control" style="margin-bottom:0">
        </div>
        <div>
          <label style="font-weight:900; color:var(--primary)">L·ªõp</label>
          <input type="text" id="editLogClass" class="form-control" placeholder="VD: GF" style="margin-bottom:0">
        </div>
      </div>

      <label style="font-weight:900; color:var(--primary); margin-top:10px; display:block">N·ªôi dung</label>
      <input type="text" id="editLogContent" class="form-control" placeholder="VD: Unit 1...">

      <label style="font-weight:900; color:var(--primary); display:block">Ghi ch√∫ chung</label>
      <input type="text" id="editLogGeneralNote" class="form-control" placeholder="...">

      <div style="border-top:3px dashed #eee; padding-top:12px; margin-top:10px">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
          <h3 style="margin:0; color:var(--dark)">Chi ti·∫øt ƒëi·ªÉm (c√≥ th·ªÉ s·ª≠a)</h3>
          <small style="color:#666; font-weight:900">S·ª≠a ƒëi·ªÉm s·∫Ω t·ª± c·ªông/tr·ª´ l·∫°i t·ªïng ƒëi·ªÉm h·ªçc sinh.</small>
        </div>

        <div style="overflow:auto; border:2px solid #eee; border-radius:12px; background:white; margin-top:10px">
          <table class="live-table" style="border-spacing:0 10px; min-width:900px">
            <thead>
              <tr>
                <th style="width:320px">H·ªçc sinh</th>
                <th style="width:160px; text-align:center">ƒêi·ªÉm</th>
                <th>Ghi ch√∫ ri√™ng</th>
              </tr>
            </thead>
            <tbody id="editLogDetailsRows"></tbody>
          </table>
        </div>

        <button class="nav-btn" style="width:100%; background:var(--primary); color:white; font-size:1.15em; margin-top:14px" onclick="saveLogEdit()">
          üíæ L∆∞u thay ƒë·ªïi nh·∫≠t k√Ω
        </button>
      </div>
    </div>
  </div>

  <!-- TITLE HISTORY MODAL -->
  <div id="titleHistoryModal" class="modal" style="z-index:3600">
    <div class="modal-content" style="max-width:980px">
      <span class="close-btn" onclick="closeModal('titleHistoryModal')">&times;</span>
      <h2 id="titleHistoryTitle" style="margin-top:0; color:var(--primary)">üìú L·ªãch s·ª≠ danh hi·ªáu</h2>
      <div id="titleHistoryBody"></div>
    </div>
  </div>

  <!-- ‚úÖ TEST EDIT MODAL (NEW) -->
  <div id="testEditModal" class="modal" style="z-index:3650">
    <div class="modal-content" style="max-width:860px">
      <span class="close-btn" onclick="closeModal('testEditModal')">&times;</span>
      <h2 style="margin-top:0; color:var(--primary)">‚úèÔ∏è S·ª¨A B√ÄI KI·ªÇM TRA</h2>

      <input type="hidden" id="editTestStuId">
      <input type="hidden" id="editTestId">

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div>
          <label style="font-weight:900; color:var(--primary)">Ng√†y</label>
          <input type="date" id="editTestDate" class="form-control" style="margin-bottom:0">
        </div>
        <div>
          <label style="font-weight:900; color:var(--primary)">T√™n b√†i</label>
          <input type="text" id="editTestName" class="form-control" style="margin-bottom:0">
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:10px">
        <div>
          <label style="font-weight:900; color:var(--primary)">ƒêi·ªÉm</label>
          <input type="number" id="editTestScore" class="form-control" style="margin-bottom:0" min="0" max="10" step="0.1">
        </div>
        <div>
          <label style="font-weight:900; color:var(--primary)">H·ªá s·ªë</label>
          <select id="editTestWeight" class="form-control" style="margin-bottom:0">
            <option value="1">H·ªá s·ªë 1</option>
            <option value="2">H·ªá s·ªë 2</option>
            <option value="3">H·ªá s·ªë 3</option>
          </select>
        </div>
        <div>
          <label style="font-weight:900; color:var(--primary)">Ghi ch√∫</label>
          <input type="text" id="editTestNote" class="form-control" style="margin-bottom:0">
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
        <button class="nav-btn btn-ok" style="flex:1" onclick="saveTestEdit()">üíæ L∆∞u</button>
        <button class="nav-btn btn-danger" style="flex:1" onclick="deleteOneTest()">üóëÔ∏è X√≥a b√†i n√†y</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ PH·∫¶N 3/3 s·∫Ω l√† TO√ÄN B·ªò <script> + ƒë√≥ng </body></html> -->
  <script>
    /* ===================== FINAL (NO DUCK) + TESTS (HE SO) ===================== */
    (function(){
      'use strict';

      const KEY_STU  = 'gx_data_final_stu';
      const KEY_LOG  = 'gx_data_final_log';
      const KEY_TEA  = 'gx_teacher_final';
      const KEY_TEST = 'gx_data_final_tests';   // ‚úÖ NEW: l∆∞u b√†i ki·ªÉm tra

      /* localStorage safe wrapper */
      const memStore = {};
      const safeStore = {
        getItem(k){
          try { return localStorage.getItem(k); }
          catch(e){ return Object.prototype.hasOwnProperty.call(memStore,k) ? memStore[k] : null; }
        },
        setItem(k,v){
          try { localStorage.setItem(k,v); }
          catch(e){ memStore[k] = v; }
        },
        removeItem(k){
          try { localStorage.removeItem(k); }
          catch(e){ delete memStore[k]; }
        }
      };

      function loadJSON(key, fallback){
        try{
          const raw = safeStore.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        }catch(e){
          return fallback;
        }
      }

      let students = loadJSON(KEY_STU, []);
      let logs     = loadJSON(KEY_LOG, []);
      let teacher  = loadJSON(KEY_TEA, null) || {name:"R·∫†P TR∆Ø·ªûNG", avatar:"English.jpg"};

      // ‚úÖ NEW: tests = m·∫£ng b√†i ki·ªÉm tra theo h·ªçc sinh
      // shape: { id, stuId, class, date, name, score, weight, note }
      let tests    = loadJSON(KEY_TEST, []);

      // migrate from older keys (best-effort)
      if(!students.length){
        const olds = [
          'gx_data_v29_stu','gx_data_v29_2_stu','gx_data_v28_stu','gx_data_v27_stu','gx_data_v26_stu',
          'gx_data_v25_stu','gx_data_v24_stu','gx_data_v23_stu','gx_data_v22_stu','gx_data_v17_stu'
        ];
        for(const k of olds){
          const v = safeStore.getItem(k);
          if(v){ try{ students = JSON.parse(v); break; }catch(e){} }
        }
      }
      if(!logs.length){
        const oldsL = [
          'gx_data_v29_log','gx_data_v29_2_log','gx_data_v28_log','gx_data_v27_log','gx_data_v26_log','gx_data_v25_log','gx_data_v24_log'
        ];
        for(const k of oldsL){
          const v = safeStore.getItem(k);
          if(v){ try{ logs = JSON.parse(v); break; }catch(e){} }
        }
      }
      const oldTeacher = safeStore.getItem('gx_teacher_v29') || safeStore.getItem('gx_teacher_v28') || safeStore.getItem('gx_teacher_v27') || safeStore.getItem('gx_teacher_v26');
      if(!safeStore.getItem(KEY_TEA) && oldTeacher){
        try{ teacher = JSON.parse(oldTeacher); }catch(e){}
      }

      function saveData(){
        safeStore.setItem(KEY_STU,  JSON.stringify(students));
        safeStore.setItem(KEY_LOG,  JSON.stringify(logs));
        safeStore.setItem(KEY_TEA,  JSON.stringify(teacher));
        safeStore.setItem(KEY_TEST, JSON.stringify(tests)); // ‚úÖ NEW
      }

      function $(id){ return document.getElementById(id); }
      window.closeModal = function(id){ const el=$(id); if(el) el.style.display='none'; };

      function escapeHtml(s){
        return String(s ?? '').replace(/[&<>"']/g, m => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[m]));
      }

      function todayISO(){ return new Date().toISOString().slice(0,10); }
      function parseDateSafe(iso){
        if(!iso) return null;
        const [y,m,d] = iso.split('-').map(n=>parseInt(n,10));
        if(!y||!m||!d) return null;
        return new Date(y, m-1, d, 12, 0, 0);
      }
      function hexToRgb(hex){
        const h = String(hex||'').replace('#','');
        if(h.length!==6) return {r:153,g:153,b:153};
        const r = parseInt(h.slice(0,2),16);
        const g = parseInt(h.slice(2,4),16);
        const b = parseInt(h.slice(4,6),16);
        return {r,g,b};
      }

      function getRank(p){
        p = p || 0;
        if(p<50)  return {c:"rank-bronze",n:"ƒê·ªíNG",cl:"#cd7f32",icon:""};
        if(p<100) return {c:"rank-silver",n:"B·∫†C",cl:"#7f8c8d",icon:""};
        if(p<150) return {c:"rank-gold",n:"V√ÄNG",cl:"#f1c40f",icon:""};
        if(p<200) return {c:"rank-platinum",n:"B·∫†CH KIM",cl:"#0fb9b1",icon:"‚ùÑÔ∏è"};
        if(p<250) return {c:"rank-emerald",n:"L·ª§C B·∫¢O",cl:"#2ecc71",icon:"üåø"};
        return {c:"rank-diamond",n:"KIM C∆Ø∆†NG",cl:"#a55eea",icon:"üíé", aura:true};
      }

      function getClasses(){
        return [...new Set(students.map(s=>s.class).filter(Boolean))]
          .sort((a,b)=>String(a).localeCompare(String(b)));
      }

      /* titles active */
      function isTitleActive(t){
        const now = parseDateSafe(todayISO());
        const s = parseDateSafe(t?.start || t?.date);
        const e = parseDateSafe(t?.end);
        if(!s) return false;
        if(now < s) return false;
        if(e && now > e) return false;
        return true;
      }
      function getActiveTitles(stu){
        const titles = Array.isArray(stu.titles) ? stu.titles : [];
        return titles.filter(isTitleActive);
      }

      /* migrate titles shape */
      students.forEach(s=>{
        if(!Array.isArray(s.titles)) s.titles = [];
        s.titles = s.titles.map(t=>{
          if(!t) return t;
          if(!t.start && t.date) t.start = t.date;
          if(!('end' in t)) t.end = "";
          if(!('note' in t)) t.note = t.note || "";
          return t;
        });
      });

      /* ======== ‚úÖ NEW: TESTS HELPERS (T√çNH ƒêI·ªÇM TB H·ªÜ S·ªê) ======== */
      function normWeight(w){
        const n = parseInt(w,10);
        return (n===1 || n===2 || n===3) ? n : 1;
      }
      function normScore(x){
        const v = Number(x);
        if(Number.isNaN(v)) return null;
        return Math.max(0, Math.min(10, v));
      }

      function getTestsOfStudent(stuId){
        return (tests || []).filter(t => String(t.stuId) === String(stuId));
      }

      function calcWeightedAvg(stuId){
        const arr = getTestsOfStudent(stuId);
        let wSum = 0;
        let swSum = 0;
        arr.forEach(t=>{
          const sc = normScore(t.score);
          const w  = normWeight(t.weight);
          if(sc===null) return;
          wSum += w;
          swSum += sc * w;
        });
        if(wSum <= 0) return null;
        return +(swSum / wSum).toFixed(2);
      }

      function calcWeightedAvgByClass(cls){
        const kids = students.filter(s => s.class === cls);
        if(!kids.length) return null;
        const vals = kids.map(s => calcWeightedAvg(s.id)).filter(v => v!==null);
        if(!vals.length) return null;
        const avg = vals.reduce((a,b)=>a+b,0) / vals.length;
        return +avg.toFixed(2);
      }

      function countTestsOfStudent(stuId){
        return getTestsOfStudent(stuId).length;
      }

      // ‚úÖ expose for report usage if needed
      window._calcWeightedAvg = calcWeightedAvg;

      function ensureTestDefaults(){
        // date default
        if($('testDate') && !$('testDate').value) $('testDate').value = todayISO();
      }

      /* ===================== TEACHER ===================== */
      function renderTeacher(){
        const avt = $('tAvatarDisplay');
        if(!avt) return;

        if(teacher.avatar && (teacher.avatar.length > 50 || teacher.avatar.includes('.'))){
          avt.innerHTML = `<img src="${teacher.avatar}" style="width:100%;height:100%;object-fit:cover">`;
        } else {
          avt.innerHTML = `<span style="font-size:60px">${escapeHtml(teacher.avatar || "üë©‚Äçüè´")}</span>`;
        }
        $('tNameDisplay').innerText = teacher.name || "R·∫†P TR∆Ø·ªûNG";
      }

      function updateClassSelects(){
        const cls = getClasses();
        const all = `<option value="ALL">T·∫•t c·∫£ l·ªõp</option>` + cls.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        const one = `<option value="">-- Ch·ªçn l·ªõp --</option>` + cls.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

        $('filterClass').innerHTML = all;
        $('inputClass').innerHTML = one;
        $('wheelClassSelect').innerHTML = one;

        $('logFilterClass').innerHTML =
          `<option value="ALL">T·∫•t c·∫£ l·ªõp</option>` + cls.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');

        // ‚úÖ NEW: testClass
        if($('testClass')) $('testClass').innerHTML = one;
      }

      /* ===================== ‚úÖ TEST TAB UI ===================== */
      window.testPopulateStudents = function(){
        const cls = $('testClass').value;
        const sel = $('testStudent');
        if(!sel) return;

        sel.innerHTML = `<option value="">-- Ch·ªçn h·ªçc sinh --</option>`;
        if(!cls) { renderTestSummary(); return; }

        students
          .filter(s=>s.class===cls)
          .sort((a,b)=>(a.name||"").localeCompare(b.name||""))
          .forEach(s=>{
            sel.innerHTML += `<option value="${s.id}">${escapeHtml(s.name||"")}</option>`;
          });

        ensureTestDefaults();
        renderTestSummary();
      };

      function renderTestMiniStat(stuId){
        const box = $('testMiniStat');
        if(!box) return;

        if(!stuId){
          box.innerHTML = `
            <div class="stat-card"><span class="stat-val">--</span><small>ƒêI·ªÇM TB</small></div>
            <div class="stat-card"><span class="stat-val">--</span><small>S·ªê B√ÄI</small></div>
            <div class="stat-card"><span class="stat-val">--</span><small>T·ªîNG H·ªÜ S·ªê</small></div>
          `;
          return;
        }

        const arr = getTestsOfStudent(stuId);
        const avg = calcWeightedAvg(stuId);
        const wSum = arr.reduce((s,t)=> s + normWeight(t.weight), 0);

        box.innerHTML = `
          <div class="stat-card"><span class="stat-val" style="color:var(--primary)">${avg===null?'--':avg}</span><small>ƒêI·ªÇM TB</small></div>
          <div class="stat-card"><span class="stat-val">${arr.length}</span><small>S·ªê B√ÄI</small></div>
          <div class="stat-card"><span class="stat-val">${wSum}</span><small>T·ªîNG H·ªÜ S·ªê</small></div>
        `;
      }

      window.renderTestSummary = function(){
        const cls = $('testClass')?.value || "";
        const stuId = $('testStudent')?.value || "";

        renderTestMiniStat(stuId || null);

        const tb = $('testRows');
        if(!tb) return;

        $('testRankingBox').innerHTML = ''; // reset ranking box

        if(!cls || !stuId){
          tb.innerHTML = `<tr><td colspan="6" style="background:white">Ch·ªçn l·ªõp + h·ªçc sinh ƒë·ªÉ xem.</td></tr>`;
          return;
        }

        const arr = getTestsOfStudent(stuId)
          .slice()
          .sort((a,b)=>{
            const da = parseDateSafe(a.date)?.getTime() || 0;
            const db = parseDateSafe(b.date)?.getTime() || 0;
            return db - da;
          });

        if(arr.length === 0){
          tb.innerHTML = `<tr><td colspan="6" style="background:white">Ch∆∞a c√≥ ƒëi·ªÉm ki·ªÉm tra.</td></tr>`;
          return;
        }

        tb.innerHTML = arr.map(t=>{
          const id = t.id;
          const sc = (t.score ?? '');
          const w  = normWeight(t.weight);
          return `
            <tr>
              <td>${escapeHtml(t.date||"")}</td>
              <td><b>${escapeHtml(t.name||"")}</b></td>
              <td style="text-align:center; font-weight:900">${escapeHtml(sc)}</td>
              <td style="text-align:center"><span class="tag-w">x${w}</span></td>
              <td>${escapeHtml(t.note||"")}</td>
              <td style="text-align:center">
                <button class="nav-btn btn-info" style="padding:6px 10px" onclick="pickTestToEdit(${id})">Ch·ªçn s·ª≠a</button>
                <button class="nav-btn btn-danger" style="padding:6px 10px" onclick="deleteTestById(${id})">X√≥a</button>
              </td>
            </tr>
          `;
        }).join('');
      };

      window.addTestScore = function(){
        const cls = $('testClass').value;
        const stuId = $('testStudent').value;
        const date = $('testDate').value || todayISO();
        const name = $('testName').value.trim();
        const scoreRaw = $('testScore').value;
        const weight = normWeight($('testWeight').value);
        const note = $('testNote').value.trim();

        if(!cls) return alert("Ch∆∞a ch·ªçn l·ªõp!");
        if(!stuId) return alert("Ch∆∞a ch·ªçn h·ªçc sinh!");
        if(!date) return alert("Thi·∫øu ng√†y!");
        if(!name) return alert("Thi·∫øu t√™n b√†i ki·ªÉm tra!");
        const sc = normScore(scoreRaw);
        if(sc === null) return alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá!");
        if(sc < 0 || sc > 10) return alert("ƒêi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 10!");

        const stu = students.find(s=>String(s.id)===String(stuId));
        if(!stu) return alert("Kh√¥ng t√¨m th·∫•y h·ªçc sinh!");

        tests.unshift({
          id: Date.now() + Math.floor(Math.random()*9999),
          stuId: stu.id,
          class: stu.class || cls,
          date,
          name,
          score: sc,
          weight,
          note
        });

        saveData();

        // reset input nh·∫π
        $('testName').value = "";
        $('testScore').value = "";
        $('testNote').value = "";
        $('testWeight').value = "1";
        ensureTestDefaults();

        renderTestSummary();
        alert("ƒê√£ l∆∞u b√†i ki·ªÉm tra!");
      };

      window.deleteTestById = function(testId){
        if(!confirm("X√≥a b√†i ki·ªÉm tra n√†y?")) return;
        tests = (tests || []).filter(t => t.id !== testId);
        saveData();
        renderTestSummary();
      };

      window.deleteAllTestsOfStudent = function(){
        const stuId = $('testStudent')?.value || "";
        if(!stuId) return alert("Ch∆∞a ch·ªçn h·ªçc sinh!");
        if(!confirm("X√≥a TO√ÄN B·ªò ƒëi·ªÉm ki·ªÉm tra c·ªßa h·ªçc sinh n√†y?")) return;

        tests = (tests || []).filter(t => String(t.stuId) !== String(stuId));
        saveData();
        renderTestSummary();
      };

      // ‚ÄúCh·ªçn s·ª≠a‚Äù 1 d√≤ng
      let pickedTestId = null;
      window.pickTestToEdit = function(testId){
        pickedTestId = testId;
        alert("ƒê√£ ch·ªçn b√†i ƒë·ªÉ s·ª≠a. B·∫•m 'S·ª≠a nhanh 1 d√≤ng' ƒë·ªÉ m·ªü form s·ª≠a.");
      };

      window.openTestEditModal = function(){
        if(!pickedTestId) return alert("B·∫°n ch∆∞a ch·ªçn b√†i n√†o. H√£y b·∫•m 'Ch·ªçn s·ª≠a' ·ªü 1 d√≤ng tr∆∞·ªõc.");
        const t = (tests || []).find(x=>x.id===pickedTestId);
        if(!t) return alert("Kh√¥ng t√¨m th·∫•y b√†i ki·ªÉm tra ƒë√£ ch·ªçn.");

        $('editTestStuId').value = String(t.stuId);
        $('editTestId').value = String(t.id);
        $('editTestDate').value = t.date || todayISO();
        $('editTestName').value = t.name || "";
        $('editTestScore').value = (t.score ?? "");
        $('editTestWeight').value = String(normWeight(t.weight));
        $('editTestNote').value = t.note || "";

        $('testEditModal').style.display = 'flex';
      };

      window.saveTestEdit = function(){
        const id = parseInt($('editTestId').value,10);
        const t = (tests || []).find(x=>x.id===id);
        if(!t) return;

        const date = $('editTestDate').value || todayISO();
        const name = $('editTestName').value.trim();
        const sc = normScore($('editTestScore').value);
        const w = normWeight($('editTestWeight').value);
        const note = $('editTestNote').value.trim();

        if(!date) return alert("Thi·∫øu ng√†y!");
        if(!name) return alert("Thi·∫øu t√™n b√†i!");
        if(sc === null) return alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá!");

        t.date = date;
        t.name = name;
        t.score = sc;
        t.weight = w;
        t.note = note;

        saveData();
        closeModal('testEditModal');
        renderTestSummary();
        alert("ƒê√£ c·∫≠p nh·∫≠t b√†i ki·ªÉm tra!");
      };

      window.deleteOneTest = function(){
        const id = parseInt($('editTestId').value,10);
        if(!id) return;
        if(!confirm("X√≥a b√†i ki·ªÉm tra n√†y?")) return;

        tests = (tests || []).filter(x=>x.id!==id);
        saveData();
        closeModal('testEditModal');
        renderTestSummary();
      };

      // ‚úÖ Ranking theo ƒëi·ªÉm TB
      window.renderTestRanking = function(){
        const cls = $('testClass')?.value || "";
        const box = $('testRankingBox');
        if(!box) return;

        const scopeStudents = (cls)
          ? students.filter(s=>s.class===cls)
          : [...students];

        const rows = scopeStudents
          .map(s=>{
            const avg = calcWeightedAvg(s.id);
            const cnt = countTestsOfStudent(s.id);
            return { id:s.id, name:s.name||"", class:s.class||"", avg, cnt };
          })
          .filter(x=>x.avg!==null) // ch·ªâ x·∫øp h·∫°ng ai c√≥ ƒëi·ªÉm
          .sort((a,b)=>{
            if(b.avg!==a.avg) return b.avg-a.avg;
            return (b.cnt-a.cnt);
          })
          .slice(0,15);

        if(rows.length===0){
          box.innerHTML = `<div class="stat-card" style="text-align:left">Ch∆∞a c√≥ d·ªØ li·ªáu ki·ªÉm tra ƒë·ªÉ x·∫øp h·∫°ng.</div>`;
          return;
        }

        box.innerHTML = `
          <div class="stat-card" style="text-align:left">
            <b>üèÜ X·∫øp h·∫°ng ƒëi·ªÉm TB</b> ${cls ? `(L·ªõp ${escapeHtml(cls)})` : `(To√†n b·ªô)`}
            <div style="margin-top:10px; overflow:auto">
              <table class="live-table" style="border-spacing:0 10px; min-width:720px">
                <thead>
                  <tr>
                    <th style="width:90px; text-align:center">H·∫°ng</th>
                    <th>H·ªçc sinh</th>
                    <th style="width:140px">L·ªõp</th>
                    <th style="width:140px; text-align:center">ƒêi·ªÉm TB</th>
                    <th style="width:140px; text-align:center">S·ªë b√†i</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows.map((r,i)=>`
                    <tr>
                      <td style="text-align:center; font-weight:900">${i+1}</td>
                      <td><b>${escapeHtml(r.name)}</b></td>
                      <td>${escapeHtml(r.class)}</td>
                      <td style="text-align:center; font-weight:900; color:var(--primary)">${r.avg}</td>
                      <td style="text-align:center">${r.cnt}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      };

      /* ===================== ‚úÖ REPORT (UPDATE: th√™m ƒëi·ªÉm TB ki·ªÉm tra) ===================== */
      window.renderReports = function(){
        const cls = getClasses();

        const topPoint = students.length
          ? students.reduce((a,b)=> (a.points||0) > (b.points||0) ? a : b)
          : {name:"--"};

        // top avg test (ai c√≥ ƒëi·ªÉm)
        const withAvg = students
          .map(s=>({s, avg: calcWeightedAvg(s.id)}))
          .filter(x=>x.avg!==null)
          .sort((a,b)=> b.avg - a.avg);

        const topTest = withAvg.length ? withAvg[0] : null;

        // stats cards
        $('reportStats').innerHTML = `
          <div class="stat-card"><span class="stat-val">${students.length}</span><small>H·ªåC SINH</small></div>
          <div class="stat-card"><span class="stat-val">${cls.length}</span><small>L·ªöP</small></div>
          <div class="stat-card"><span class="stat-val" style="color:var(--primary)">${escapeHtml(topPoint.name||"--")}</span><small>TOP ƒêI·ªÇM C·ªòNG</small></div>
          <div class="stat-card"><span class="stat-val" style="color:#8e44ad">${topTest ? topTest.avg : "--"}</span><small>TOP ƒêI·ªÇM TB</small></div>
        `;

        // chart: ƒëi·ªÉm TB ƒëi·ªÉm c·ªông theo l·ªõp (gi·ªØ nh∆∞ c≈©)
        const avgs = cls.map(c=>{
          const arr = students.filter(x=>x.class===c);
          return arr.reduce((sum,s)=>sum+(s.points||0),0)/(arr.length||1);
        });

        const ctx = $('classChart');
        if(window.myChart) window.myChart.destroy();
        window.myChart = new Chart(ctx, { type:'bar', data:{ labels:cls, datasets:[{ label:'ƒêi·ªÉm TB (ƒëi·ªÉm c·ªông)', data:avgs }] } });

        // right box: top list (hi·ªÉn th·ªã c·∫£ 2 ki·ªÉu)
        const top5Points = [...students].sort((a,b)=>(b.points||0)-(a.points||0)).slice(0,5);
        const top5Tests = withAvg.slice(0,5);

        let html = '';
        html += `<li style="padding:6px 0; font-weight:900; color:#444">üèÖ Top ƒëi·ªÉm c·ªông</li>`;
        html += top5Points.map(s=>`<li style="padding:6px 0"><b>${escapeHtml(s.name||"")}</b> (${escapeHtml(s.class||"")}): ${s.points||0} pts</li>`).join('');

        html += `<li style="padding:10px 0 6px; font-weight:900; color:#444; border-top:2px dashed #eee; margin-top:6px">üß™ Top ƒëi·ªÉm TB ki·ªÉm tra</li>`;
        html += top5Tests.length
          ? top5Tests.map(x=>`<li style="padding:6px 0"><b>${escapeHtml(x.s.name||"")}</b> (${escapeHtml(x.s.class||"")}): <b style="color:#8e44ad">${x.avg}</b> (${countTestsOfStudent(x.s.id)} b√†i)</li>`).join('')
          : `<li style="padding:6px 0; color:#777">Ch∆∞a c√≥ d·ªØ li·ªáu ki·ªÉm tra.</li>`;

        $('growthList').innerHTML = html;
      };

      /* ===================== EXCEL (UPDATE: th√™m sheet Tests) ===================== */
      window.exportExcel = function(){
        if(typeof XLSX === 'undefined') return alert("Thi·∫øu th∆∞ vi·ªán XLSX (b·ªã ch·∫∑n CDN?)");

        const ws = XLSX.utils.json_to_sheet(students);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Students");

        const ws2 = XLSX.utils.json_to_sheet(logs);
        XLSX.utils.book_append_sheet(wb, ws2, "Logs");

        const ws3 = XLSX.utils.json_to_sheet(tests || []);
        XLSX.utils.book_append_sheet(wb, ws3, "Tests");

        XLSX.writeFile(wb, "GanhXiec_FINAL.xlsx");
      };

      /* ===================== TAB SWITCH (UPDATE: test tab) ===================== */
      window.switchTab = function(t){
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        document.querySelectorAll('.nav-btn.active').forEach(b=>b.classList.remove('active'));

        const tab = document.getElementById('tab-'+t);
        const btn = document.getElementById('btn-'+t);
        if(tab) tab.classList.add('active');
        if(btn) btn.classList.add('active');

        if(t==='dashboard'){ initDashboard(); }
        if(t==='input'){ updateClassSelects(); setInputDateTodayIfEmpty(); renderLogs(); }
        if(t==='test'){
          updateClassSelects();
          ensureTestDefaults();
          // gi·ªØ l·ª±a ch·ªçn n·∫øu c√≥
          if(!$('testClass').value) $('testStudent').innerHTML = `<option value="">-- Ch·ªçn h·ªçc sinh --</option>`;
          renderTestSummary();
        }
        if(t==='wheel'){ updateClassSelects(); if(wNames.length>=2) drawWheel(); }
        if(t==='report'){ renderReports(); }
      };

      /* ===================== DASHBOARD ===================== */
      window.renderDashboard = function(){
        const grid = $('studentGrid');
        if(!grid) return;

        const term = ($('searchName').value || '').toLowerCase();
        const fCls = $('filterClass').value;
        const sort = $('sortType').value;

        let list = students.filter(s =>
          ((s.name||"").toLowerCase().includes(term)) &&
          (fCls==='ALL' || s.class===fCls)
        );

        if(sort==='points') list.sort((a,b)=>(b.points||0)-(a.points||0));
        else if(sort==='name') list.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
        else if(sort==='rank') list.sort((a,b)=>(b.points||0)-(a.points||0));

        grid.innerHTML = '';

        list.forEach(s=>{
          const r = getRank(s.points||0);
          const rgb = hexToRgb(r.cl);
          const isImg = (s.avatar||"").length > 50;
          const avt = isImg ? `<img src="${s.avatar}">` : `${escapeHtml(s.avatar||"üôÇ")}`;
          const floatIcon = r.icon ? `<div class="rank-icon-float">${r.icon}</div>` : '';
          const aura = r.aura ? 'card-aura' : '';

          const actives = getActiveTitles(s);
          const latest = actives.length ? actives[0] : null;
          const starActive = actives.length ? 'active' : '';

          const titleSlot = latest ? `
            <div class="title-slot">
              <div style="font-size:0.86em; color:var(--primary); font-weight:900">
                üåü ${escapeHtml(latest.title)} <span style="color:#777">(${actives.length})</span>
              </div>
              <div style="font-size:0.78em; color:#666; font-weight:900">
                ‚è≥ ${escapeHtml(latest.start || '')}
                ${latest.end ? ` ‚Üí ${escapeHtml(latest.end)}` : ` ‚Üí (M√£i On Top)`}
              </div>
            </div>
          ` : `
            <div class="title-slot">
              <div style="font-size:0.86em; color:#bbb; font-weight:900"> </div>
              <div style="font-size:0.78em; color:#bbb; font-weight:900"> </div>
            </div>
          `;

          grid.innerHTML += `
            <div class="card ${aura}" style="border-color:${r.cl}" onclick="openStudentModal(${s.id})">
              <div class="rank-frame ${r.c}" style="--rcol:${r.cl};--rcolrgb:${rgb.r},${rgb.g},${rgb.b}">
                ${floatIcon}${avt}
              </div>
              <div class="rank-badge" style="background:${r.cl}">${r.n}</div>

              <h3 class="stu-name">${escapeHtml(s.name||"")}</h3>
              <span style="color:#777; font-weight:900">${escapeHtml(s.class||"")}</span>
              <div class="card-score" style="color:${r.cl}">${s.points||0}</div>

              ${titleSlot}

              <div class="card-actions" onclick="event.stopPropagation();">
                <div class="icon-btn star-btn ${starActive}" onclick="promptFeature(${s.id})" title="Vinh danh"><i class="fas fa-star"></i></div>
                <div class="icon-btn" style="color:#8e44ad" onclick="openTitleHistory(${s.id})" title="L·ªãch s·ª≠ danh hi·ªáu"><i class="fas fa-scroll"></i></div>
                <div class="icon-btn edit-btn" onclick="openStudentModal(${s.id})" title="S·ª≠a"><i class="fas fa-edit"></i></div>
                <div class="icon-btn del-btn" onclick="delStu(${s.id})" title="X√≥a"><i class="fas fa-trash"></i></div>
              </div>
            </div>
          `;
        });
      };

      window.delStu = function(id){
        if(confirm("X√≥a b√© n√†y kh·ªèi g√°nh xi·∫øc?")){
          students = students.filter(s=>s.id!==id);
          // ‚úÖ NEW: x√≥a lu√¥n test c·ªßa b√©
          tests = (tests||[]).filter(t=>String(t.stuId)!==String(id));
          saveData();
          updateClassSelects();
          renderDashboard();
          renderFeatured();
        }
      };

      /* ===================== FEATURE (VINH DANH) ===================== */
      window.promptFeature = function(id){
        $('featId').value = id;
        $('featReason').value = "";
        $('featNote').value = "";
        const t = todayISO();
        $('featStart').value = t;
        const end = new Date(); end.setDate(end.getDate()+7);
        $('featEnd').value = end.toISOString().slice(0,10);
        $('featurePromptModal').style.display = 'flex';
      };

      window.confirmFeature = function(){
        const id = parseInt($('featId').value,10);
        const s = students.find(x=>x.id===id);
        if(!s) return;

        const title = $('featReason').value.trim();
        const start = $('featStart').value || todayISO();
        const end = $('featEnd').value || "";
        const note = $('featNote').value.trim();

        if(!title) return alert("Ch∆∞a nh·∫≠p danh hi·ªáu!");
        const ds = parseDateSafe(start);
        const de = end ? parseDateSafe(end) : null;
        if(!ds) return alert("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng h·ª£p l·ªá!");
        if(de && de < ds) return alert("Ng√†y k·∫øt th√∫c ph·∫£i >= ng√†y b·∫Øt ƒë·∫ßu!");

        if(!Array.isArray(s.titles)) s.titles = [];
        s.titles.unshift({ id: Date.now() + Math.floor(Math.random()*9999), title, start, end, note });

        saveData();
        closeModal('featurePromptModal');
        renderDashboard();
        renderFeatured();
      };

      window.renderFeatured = function(){
        const list = $('featuredList');
        if(!list) return;

        const feats = students
          .filter(s => getActiveTitles(s).length > 0)
          .sort((a,b)=>{
            const da = parseDateSafe(getActiveTitles(a)[0]?.start)?.getTime() || 0;
            const db = parseDateSafe(getActiveTitles(b)[0]?.start)?.getTime() || 0;
            return db - da;
          });

        list.innerHTML = feats.length ? '' : `<span style="color:#777; padding:0 20px; font-weight:900">Ch∆∞a c√≥ ai (ho·∫∑c danh hi·ªáu ƒë√£ h·∫øt h·∫°n)...</span>`;

        feats.forEach(s=>{
          const r = getRank(s.points||0);
          const isImg = (s.avatar||"").length>50;
          const avt = isImg
            ? `<img src="${s.avatar}" style="width:64px;height:64px;border-radius:50%;border:4px solid ${r.cl};object-fit:cover">`
            : `<span style="font-size:52px">${escapeHtml(s.avatar||"üôÇ")}</span>`;

          const actives = getActiveTitles(s);
          const latest = actives[0];

          list.innerHTML += `
            <div class="f-card" style="border-color:${r.cl}">
              <div class="f-inner">
                <div class="f-topline">
                  <span style="font-size:22px">üëë</span>
                  <span class="f-rankpill" style="color:${r.cl}">${r.n}</span>
                </div>

                <div style="margin:10px 0 6px">${avt}</div>

                <div style="font-weight:900; font-size:1.2em; text-transform:uppercase">${escapeHtml(s.name||"")}</div>
                <div style="font-weight:900; color:#444">${escapeHtml(s.class||"")}</div>

                <div class="f-points" style="background:${r.cl}">${s.points||0} pts</div>

                <div class="f-reason" style="margin-top:10px">
                  üåü ${escapeHtml(latest?.title || "")} <span style="opacity:0.9">(${actives.length})</span>
                </div>

                <div style="margin-top:8px; font-size:.78em; color:#555; font-weight:900">
                  ‚è≥ ${escapeHtml(latest?.start || "")}
                  ${latest?.end ? ` ‚Üí ${escapeHtml(latest.end)}` : ` ‚Üí (M√£i On Top)`}
                </div>

                <div style="margin-top:7px">
                  <button class="nav-btn f-subbtn" onclick="openTitleHistory(${s.id})">üìú L·ªãch s·ª≠ danh hi·ªáu</button>
                </div>
              </div>
            </div>
          `;
        });
      };

      /* ===================== TITLE HISTORY + EDIT ===================== */
      window.openTitleHistory = function(stuId){
        const s = students.find(x=>x.id===stuId);
        if(!s) return;

        const titles = Array.isArray(s.titles) ? s.titles : [];
        $('titleHistoryTitle').innerText = `üìú ${s.name || ""} ‚Äì L·ªãch s·ª≠ danh hi·ªáu`;

        const rows = titles.map(t=>{
          const active = isTitleActive(t);
          return `
            <tr>
              <td style="width:140px"><b>${escapeHtml(t.start || t.date || "")}</b></td>
              <td style="width:140px"><b>${t.end ? escapeHtml(t.end) : '<span style="color:#888">(kh√¥ng)</span>'}</b></td>
              <td>
                <b style="color:var(--primary)">${escapeHtml(t.title || "")}</b>
                ${active ? `<span style="margin-left:8px; font-weight:900; color:#10ac84">(ƒëang hi·ªáu l·ª±c)</span>` : `<span style="margin-left:8px; font-weight:900; color:#999">(h·∫øt h·∫°n)</span>`}
              </td>
              <td style="width:260px">${escapeHtml(t.note || "")}</td>
              <td style="width:200px; text-align:center">
                <button class="nav-btn" style="padding:6px 10px" onclick="editTitle(${stuId}, ${t.id})">S·ª≠a</button>
                <button class="nav-btn" style="padding:6px 10px; background:#c0392b; color:white; border-color:#c0392b" onclick="deleteTitle(${stuId}, ${t.id})">X√≥a</button>
              </td>
            </tr>
          `;
        }).join('');

        $('titleHistoryBody').innerHTML = `
          <div class="stat-card" style="margin-bottom:12px; text-align:left">
            <b>Th√¥ng tin:</b> ${escapeHtml(s.class || "")}
            ‚Ä¢ T·ªïng danh hi·ªáu: <b>${titles.length}</b>
            ‚Ä¢ ƒêang hi·ªáu l·ª±c: <b>${getActiveTitles(s).length}</b>
          </div>
          <div style="overflow:auto; border:2px solid #eee; border-radius:12px; background:white">
            <table class="live-table" style="border-spacing:0 10px; min-width:900px">
              <thead><tr><th>B·∫Øt ƒë·∫ßu</th><th>K·∫øt th√∫c</th><th>Danh hi·ªáu</th><th>Ghi ch√∫</th><th>H√†nh ƒë·ªông</th></tr></thead>
              <tbody>${rows || `<tr><td colspan="5" style="background:white">Ch∆∞a c√≥ danh hi·ªáu.</td></tr>`}</tbody>
            </table>
          </div>
        `;

        $('titleHistoryModal').style.display = 'flex';
      };

      window.deleteTitle = function(stuId, titleId){
        const s = students.find(x=>x.id===stuId);
        if(!s) return;
        if(!confirm("X√≥a danh hi·ªáu n√†y kh·ªèi l·ªãch s·ª≠?")) return;

        s.titles = (s.titles || []).filter(t=>t.id!==titleId);
        saveData();
        renderDashboard();
        renderFeatured();
        openTitleHistory(stuId);
      };

      window.editTitle = function(stuId, titleId){
        const s = students.find(x=>x.id===stuId);
        if(!s) return;
        const t = (s.titles || []).find(x=>x.id===titleId);
        if(!t) return;

        $('editStuId').value = stuId;
        $('editTitleId').value = titleId;
        $('editTitleText').value = t.title || "";
        $('editStart').value = t.start || t.date || todayISO();
        $('editEnd').value = t.end || "";
        $('editNote').value = t.note || "";
        $('titleEditModal').style.display = 'flex';
      };

      window.saveTitleEdit = function(){
        const stuId = parseInt($('editStuId').value,10);
        const titleId = parseInt($('editTitleId').value,10);
        const s = students.find(x=>x.id===stuId);
        if(!s) return;

        const t = (s.titles || []).find(x=>x.id===titleId);
        if(!t) return;

        const title = $('editTitleText').value.trim();
        const start = $('editStart').value || todayISO();
        const end = $('editEnd').value || "";
        const note = $('editNote').value.trim();

        if(!title) return alert("Danh hi·ªáu kh√¥ng ƒë∆∞·ª£c tr·ªëng!");
        const ds = parseDateSafe(start);
        const de = end ? parseDateSafe(end) : null;
        if(!ds) return alert("Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng h·ª£p l·ªá!");
        if(de && de < ds) return alert("Ng√†y k·∫øt th√∫c ph·∫£i >= ng√†y b·∫Øt ƒë·∫ßu!");

        t.title = title;
        t.start = start;
        t.end = end;
        t.note = note;

        saveData();
        closeModal('titleEditModal');
        renderDashboard();
        renderFeatured();
        openTitleHistory(stuId);
      };

      /* ===================== AVATAR SELECT ===================== */
      const avatarData = [
        { group: "üê∂ H·ªÜ 'BOSS'", items: [ {i:"üê∂",t:"Ch√≥ Ng√°o"}, {i:"üê±",t:"M√®o Ch·∫£nh"}, {i:"üêπ",t:"Hamster √ö"}, {i:"üê∞",t:"Th·ªè TƒÉng ƒê·ªông"}, {i:"üê¢",t:"R√πa Ch·∫≠m"} ] },
        { group: "ü¶Å H·ªÜ S·ªû TH√ö", items: [ {i:"üêº",t:"Panda Th·ª©c Khuya"}, {i:"üê∏",t:"·∫æch ·ªòp Oppa"}, {i:"ü¶ä",t:"C√°o Drama"}, {i:"üê∑",t:"Heo L∆∞·ªùi"}, {i:"üêµ",t:"Kh·ªâ ƒê√≠t ƒê·ªè"}, {i:"üêß",t:"C√°nh C·ª•t L·∫°nh L√πng"}, {i:"ü¶Å",t:"S∆∞ T·ª≠ T√≥c D√†i"}, {i:"ü¶Ñ",t:"K·ª≥ L√¢n Th√≠ch M√∫a"} ] },
        { group: "ü§° H·ªÜ T√ÇM LINH", items: [ {i:"ü§°",t:"Ch√∫ H·ªÅ L√πn"}, {i:"üëª",t:"Ma Qu√® Ch√¢n"}, {i:"üëΩ",t:"Alien Da ƒê·ªè"}, {i:"ü§ñ",t:"Robot H·∫øt Pin"}, {i:"üí©",t:"C·ª•c....V√†ng"}, {i:"üíÄ",t:"X∆∞∆°ng Gi·∫£m C√¢n"} ] },
        { group: "üçî H·ªÜ ƒê·ªí ƒÇN", items: [ {i:"üçÑ",t:"N·∫•m Ng∆° Ng√°c"}, {i:"ü•î",t:"Khoai T√¢y Chi√™n"}, {i:"üçï",t:"Pizza Ph√¥ Mai"}, {i:"üçî",t:"Burger B·ª± Ch√† B√°"}, {i:"ü•ë",t:"B∆° Mlem Mlem"} ] }
      ];

      function setupAvatarSelect(){
        const c = $('avatarOptions');
        if(!c) return;
        c.innerHTML = '';
        avatarData.forEach(g=>{
          c.innerHTML += `<div class="option-group-label">${g.group}</div>`;
          g.items.forEach(it=>{
            c.innerHTML += `<div class="custom-option" onclick="selectAvt('${it.i}','${escapeHtml(it.t)}', event)">
              <span class="opt-icon">${it.i}</span>${escapeHtml(it.t)}
            </div>`;
          });
        });
      }

      window.toggleAvatarDropdown = function(e){
        if(e) e.stopPropagation();
        $('avatarWrapper').classList.toggle('open');
      };

      window.selectAvt = function(i,t,e){
        if(e) e.stopPropagation();
        $('stuSelectedAvatar').value = i;
        $('avatarTriggerText').innerText = i + " " + t;
        $('avatarWrapper').classList.remove('open');
        $('stuImageFile').value = '';
      };

      document.addEventListener('click',(e)=>{
        const wrap = $('avatarWrapper');
        if(wrap && !wrap.contains(e.target)) wrap.classList.remove('open');
      });

      /* ===================== STUDENT MODAL ===================== */
      let curEditId = null;

      window.openAddModal = function(){
        curEditId = null;
        $('modalTitle').innerText="TH√äM B√â M·ªöI";
        $('stuId').value="";
        $('stuName').value="";
        $('stuClass').value="";
        $('stuPoints').value=0;
        $('stuGift').value="";
        $('stuSelectedAvatar').value="üê∂";
        $('avatarTriggerText').innerText="üê∂ Ch·ªçn Avatar...";
        $('stuImageFile').value="";
        $('avatarWrapper').classList.remove('open');
        $('studentModal').style.display='flex';
      };

      window.openStudentModal = function(id){
        curEditId = id;
        const s = students.find(x=>x.id==id);
        if(!s) return;

        $('modalTitle').innerText="S·ª¨A H·ªí S∆†";
        $('stuId').value=s.id;
        $('stuName').value=s.name||"";
        $('stuClass').value=s.class||"";
        $('stuPoints').value=s.points||0;
        $('stuGift').value=s.gift||"";
        $('stuImageFile').value="";
        $('avatarWrapper').classList.remove('open');

        if((s.avatar||"").length<10){
          $('avatarTriggerText').innerText=(s.avatar || "üê∂");
          $('stuSelectedAvatar').value=(s.avatar || "üê∂");
        } else {
          $('avatarTriggerText').innerText="üñºÔ∏è ƒêang d√πng ·∫£nh upload";
        }

        $('studentModal').style.display='flex';
      };

      window.saveStudent = function(){
        const n = $('stuName').value.trim();
        const c = $('stuClass').value.trim();
        const p = parseInt($('stuPoints').value,10) || 0;
        const g = $('stuGift').value.trim();
        const emj = $('stuSelectedAvatar').value;
        const f = $('stuImageFile').files[0];

        if(!n || !c) return alert("Thi·∫øu t√™n/l·ªõp");

        const commit = (avt)=>{
          if(curEditId){
            const s = students.find(x=>x.id==curEditId);
            if(!s) return;
            s.name=n; s.class=c; s.points=p; s.gift=g;
            if(avt) s.avatar=avt;
            if(!Array.isArray(s.titles)) s.titles=[];
          } else {
            students.push({id:Date.now(), name:n, class:c, points:p, gift:g, avatar:avt||emj, titles:[]});
          }
          saveData();
          updateClassSelects();
          renderDashboard();
          renderFeatured();
          closeModal('studentModal');
        };

        if(f){
          const r = new FileReader();
          r.onload = e => commit(e.target.result);
          r.readAsDataURL(f);
        } else {
          if(curEditId) commit(null);
          else commit(emj);
        }
      };

      /* ===================== TEACHER ===================== */
      window.openTeacherModal = function(){
        $('tNameInput').value = teacher.name || "R·∫†P TR∆Ø·ªûNG";
        $('teacherModal').style.display='flex';
      };

      window.saveTeacher = function(){
        teacher.name = $('tNameInput').value || "R·∫†P TR∆Ø·ªûNG";
        const f = $('tImageFile').files[0];
        if(f){
          const r = new FileReader();
          r.onload = e => { teacher.avatar=e.target.result; saveData(); renderTeacher(); };
          r.readAsDataURL(f);
        } else {
          saveData(); renderTeacher();
        }
        closeModal('teacherModal');
      };

      /* ===================== NH·∫¨T K√ù ===================== */
      let sessionData = {};
      window.sessionData = sessionData;

      function setInputDateTodayIfEmpty(){
        const el = $('inputDate');
        if(el && !el.value) el.value = todayISO();
      }

      window.startSession = function(){
        const cls = $('inputClass').value;
        if(!cls){ $('liveArea').style.display='none'; return; }

        $('liveArea').style.display='block';
        $('studentLiveRows').innerHTML = '';

        sessionData = {};
        window.sessionData = sessionData;

        const kids = students.filter(s=>s.class===cls);
        if(kids.length === 0){
          $('studentLiveRows').innerHTML = `<tr><td colspan="3" style="background:white">L·ªõp n√†y ch∆∞a c√≥ h·ªçc sinh.</td></tr>`;
          return;
        }

        kids.forEach(s=>{
          window.sessionData[s.id] = {points:0, note:''};
          const avt = (s.avatar||"").length>50
            ? `<img src="${s.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover">`
            : `<span style="font-size:1.5em">${escapeHtml(s.avatar||"üôÇ")}</span>`;

          $('studentLiveRows').innerHTML += `
            <tr>
              <td>
                <div style="display:flex; align-items:center; gap:10px">
                  ${avt} <b>${escapeHtml(s.name||"")}</b>
                </div>
              </td>
              <td style="text-align:center">
                <div style="background:#eee;padding:6px 8px;border-radius:10px;display:inline-block">
                  <button class="btn-point bg-red-dark" onclick="adj(${s.id},-10)">-10</button>
                  <button class="btn-point bg-red" onclick="adj(${s.id},-5)">-5</button>
                  <button class="btn-point bg-red" onclick="adj(${s.id},-1)">-1</button>
                  <span style="font-weight:900;width:52px;display:inline-block" id="sc-${s.id}">0</span>
                  <button class="btn-point bg-green" onclick="adj(${s.id},1)">+1</button>
                  <button class="btn-point bg-green" onclick="adj(${s.id},5)">+5</button>
                  <button class="btn-point bg-green-dark" onclick="adj(${s.id},10)">+10</button>
                </div>
              </td>
              <td>
                <input class="form-control" placeholder="..." style="margin:0"
                  oninput="sessionData[${s.id}].note=this.value">
              </td>
            </tr>
          `;
        });
      };

      window.adj = function(id, v){
        if(!window.sessionData[id]) return;
        window.sessionData[id].points += v;
        const val = window.sessionData[id].points;
        const el = document.getElementById(`sc-${id}`);
        if(el) el.innerText = (val>0?'+':'') + val;
      };

      window.finishSession = function(){
        const d = $('inputDate').value;
        const c = $('inputClass').value;
        const ct = $('inputContent').value.trim();
        const note = $('inputGeneralNote').value.trim();

        if(!d || !ct) return alert("Thi·∫øu ng√†y/n·ªôi dung!");
        if(!c) return alert("Ch∆∞a ch·ªçn l·ªõp!");

        const det = [];
        for(const sid in window.sessionData){
          const s = students.find(x=>x.id==sid);
          if(s){
            s.points = (s.points||0) + window.sessionData[sid].points;
            if(s.points < 0) s.points = 0;
            det.push({sid:s.id, name:s.name, points:window.sessionData[sid].points, note:window.sessionData[sid].note});
          }
        }

        logs.unshift({id:Date.now(), date:d, class:c, content:ct, generalNote:note, details:det});
        saveData();

        alert("ƒê√£ l∆∞u!");
        renderDashboard();
        renderFeatured();

        $('inputContent').value = "";
        $('inputGeneralNote').value = "";
        $('inputClass').value = "";
        $('liveArea').style.display = 'none';

        renderLogs();
        switchTab('dashboard');
      };

      function monthFromISO(iso){ return (iso && iso.length>=7) ? iso.slice(0,7) : ""; }

      window.renderLogs = function(){
        const tb = $('logsRows');
        const fCls = $('logFilterClass').value || 'ALL';
        const fMonth = $('logFilterMonth').value || '';
        const sort = $('logSort').value || 'desc';

        let view = [...(logs || [])];
        if(fCls !== 'ALL') view = view.filter(l => (l.class||'') === fCls);
        if(fMonth) view = view.filter(l => monthFromISO(l.date) === fMonth);

        view.sort((a,b)=>{
          const da = parseDateSafe(a.date)?.getTime() || 0;
          const db = parseDateSafe(b.date)?.getTime() || 0;
          return (sort==='asc') ? (da-db) : (db-da);
        });

        if(view.length === 0){
          tb.innerHTML = `<tr><td colspan="5" style="background:white">Ch∆∞a c√≥ nh·∫≠t k√Ω n√†o (theo b·ªô l·ªçc hi·ªán t·∫°i).</td></tr>`;
          return;
        }

        tb.innerHTML = view.slice(0,120).map(l=>`
          <tr>
            <td>${escapeHtml(l.date || "")}</td>
            <td><b>${escapeHtml(l.class || "")}</b></td>
            <td>${escapeHtml(l.content || "")}</td>
            <td>${escapeHtml(l.generalNote || "")}</td>
            <td>
              <button class="nav-btn" style="padding:6px 12px" onclick="openLogDetail(${l.id})">Xem</button>
              <button class="nav-btn" style="padding:6px 12px; background:#2980b9; color:white; border-color:#2980b9" onclick="openLogEdit(${l.id})">S·ª≠a</button>
              <button class="nav-btn" style="padding:6px 12px; background:#c0392b; color:white; border-color:#c0392b" onclick="deleteLog(${l.id})">X√≥a</button>
            </td>
          </tr>
        `).join('');
      };

      window.openLogDetail = function(id){
        const l = logs.find(x=>x.id===id);
        if(!l) return;

        const rows = (l.details || []).map(d=>`
          <tr>
            <td style="width:280px"><b>${escapeHtml(d.name || "")}</b></td>
            <td style="width:160px; text-align:center; font-weight:900; color:${(d.points||0)>=0 ? '#10ac84' : '#ee5253'}">
              ${(d.points||0)>0 ? '+' : ''}${d.points||0}
            </td>
            <td>${escapeHtml(d.note || "")}</td>
          </tr>
        `).join('');

        $('logDetailBody').innerHTML = `
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
            <div class="stat-card" style="flex:1; min-width:160px"><span class="stat-val">${escapeHtml(l.date || "--")}</span><small>NG√ÄY</small></div>
            <div class="stat-card" style="flex:1; min-width:160px"><span class="stat-val">${escapeHtml(l.class || "--")}</span><small>L·ªöP</small></div>
            <div class="stat-card" style="flex:2; min-width:260px"><span class="stat-val" style="font-size:1.25em">${escapeHtml(l.content || "--")}</span><small>N·ªòI DUNG</small></div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:12px">
            <button class="nav-btn" style="background:#2980b9; color:white; border-color:#2980b9" onclick="openLogEdit(${l.id}); closeModal('logDetailModal')">‚úèÔ∏è S·ª≠a nh·∫≠t k√Ω n√†y</button>
          </div>

          <div style="background:#fff; border:2px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px">
            <b>üì£ Ghi ch√∫ chung:</b> ${escapeHtml(l.generalNote || "(Kh√¥ng c√≥)")}
          </div>

          <div style="overflow:auto; border:2px solid #eee; border-radius:12px; background:white">
            <table class="live-table" style="border-spacing:0 10px; min-width:760px">
              <thead><tr><th>H·ªçc sinh</th><th style="text-align:center">ƒêi·ªÉm</th><th>Ghi ch√∫ ri√™ng</th></tr></thead>
              <tbody>${rows || `<tr><td colspan="3" style="background:white">Kh√¥ng c√≥ chi ti·∫øt.</td></tr>`}</tbody>
            </table>
          </div>
        `;
        $('logDetailModal').style.display='flex';
      };

      window.deleteLog = function(id){
        if(!confirm("X√≥a nh·∫≠t k√Ω n√†y? (Kh√¥ng ho√†n l·∫°i ƒëi·ªÉm ƒë√£ c·ªông/tr·ª´ khi l∆∞u nh·∫≠t k√Ω)")) return;
        logs = logs.filter(l=>l.id!==id);
        saveData();
        renderLogs();
      };

      window.clearAllLogs = function(){
        if(!confirm("X√≥a T·∫§T C·∫¢ nh·∫≠t k√Ω? (Kh√¥ng ho√†n l·∫°i ƒëi·ªÉm ƒë√£ c·ªông/tr·ª´ khi l∆∞u nh·∫≠t k√Ω)")) return;
        logs = [];
        saveData();
        renderLogs();
      };

      window.openLogEdit = function(id){
        const l = logs.find(x=>x.id===id);
        if(!l) return;

        $('editLogId').value = String(l.id);
        $('editLogDate').value = l.date || todayISO();
        $('editLogClass').value = l.class || "";
        $('editLogContent').value = l.content || "";
        $('editLogGeneralNote').value = l.generalNote || "";

        const tb = $('editLogDetailsRows');
        const details = Array.isArray(l.details) ? l.details : [];
        tb.innerHTML = details.map(d=>{
          const pts = (typeof d.points === 'number') ? d.points : (parseInt(d.points,10) || 0);
          const note = d.note || "";
          return `
            <tr>
              <td><b>${escapeHtml(d.name || "")}</b></td>
              <td style="text-align:center">
                <input type="number" class="form-control" style="width:140px; margin:0 auto; text-align:center"
                  id="elp-${d.sid}" value="${pts}">
              </td>
              <td>
                <input type="text" class="form-control" style="margin:0"
                  id="eln-${d.sid}" value="${escapeHtml(note).replace(/"/g,'&quot;')}">
              </td>
            </tr>
          `;
        }).join('') || `<tr><td colspan="3" style="background:white">Kh√¥ng c√≥ chi ti·∫øt ƒë·ªÉ s·ª≠a.</td></tr>`;

        $('logEditModal').style.display = 'flex';
      };

      window.saveLogEdit = function(){
        const id = parseInt($('editLogId').value,10);
        const l = logs.find(x=>x.id===id);
        if(!l) return;

        const newDate = $('editLogDate').value;
        const newClass = $('editLogClass').value.trim();
        const newContent = $('editLogContent').value.trim();
        const newGeneral = $('editLogGeneralNote').value.trim();

        if(!newDate || !newContent) return alert("Thi·∫øu ng√†y / n·ªôi dung!");
        if(!newClass) return alert("Thi·∫øu l·ªõp!");

        const oldDetails = Array.isArray(l.details) ? l.details : [];
        const newDetails = oldDetails.map(d=>{
          const ptsEl = document.getElementById(`elp-${d.sid}`);
          const noteEl = document.getElementById(`eln-${d.sid}`);
          const newPts = parseInt(ptsEl ? ptsEl.value : d.points, 10) || 0;
          const newNote = (noteEl ? noteEl.value : (d.note||"")).trim();
          return { sid:d.sid, name:d.name, points:newPts, note:newNote };
        });

        // b√π ƒëi·ªÉm v√†o t·ªïng h·ªçc sinh (diff)
        newDetails.forEach(nd=>{
          const od = oldDetails.find(x=>x.sid===nd.sid);
          const oldPts = od ? (parseInt(od.points,10) || 0) : 0;
          const diff = nd.points - oldPts;
          const stu = students.find(s=>s.id===nd.sid);
          if(stu){
            stu.points = (stu.points||0) + diff;
            if(stu.points < 0) stu.points = 0;
          }
        });

        l.date = newDate;
        l.class = newClass;
        l.content = newContent;
        l.generalNote = newGeneral;
        l.details = newDetails;

        saveData();
        closeModal('logEditModal');
        renderDashboard();
        renderFeatured();
        renderLogs();
        alert("ƒê√£ c·∫≠p nh·∫≠t nh·∫≠t k√Ω!");
      };

      /* ===================== WHEEL ===================== */
      let audio = null;
      try{
        audio = new Audio('vit.mp3');
        audio.loop = true;
      }catch(e){ audio = null; }

      let wNames = [], startAng = 0, arc = 0;

      window.populateWheelList = function(){
        const cls = $('wheelClassSelect').value;
        if(cls){
          $('wheelNamesList').value = students.filter(s=>s.class===cls).map(s=>s.name).join('\n');
        }
      };

      window.updateWheelFromList = function(){
        wNames = $('wheelNamesList').value.split('\n').map(x=>x.trim()).filter(Boolean);
        if(wNames.length < 2){
          $('spinBtn').disabled = true;
          return alert("C·∫ßn √≠t nh·∫•t 2 t√™n!");
        }
        arc = Math.PI*2 / wNames.length;
        drawWheel();
        $('spinBtn').disabled = false;
      };

      function drawWheel(){
        const canvas = $('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const W = canvas.width, H = canvas.height;
        const cx = W/2, cy = H/2;

        ctx.clearRect(0,0,W,H);

        const colors = ["#FF5733","#33FF57","#3357FF","#FF33A1","#F3FF33","#33FFF5","#ffa502","#ff4757","#2ed573","#3742fa"];
        const R = Math.min(W,H) * 0.44;

        ctx.beginPath();
        ctx.arc(cx,cy,R+18,0,Math.PI*2);
        ctx.fillStyle="rgba(255,255,255,0.90)";
        ctx.fill();

        wNames.forEach((n,i)=>{
          const ang = startAng + i*arc;
          ctx.fillStyle = colors[i % colors.length];
          ctx.beginPath();
          ctx.moveTo(cx,cy);
          ctx.arc(cx,cy,R,ang,ang+arc,false);
          ctx.closePath();
          ctx.fill();

          ctx.save();
          ctx.fillStyle="rgba(0,0,0,0.88)";
          ctx.translate(cx + Math.cos(ang+arc/2)*R*0.70, cy + Math.sin(ang+arc/2)*R*0.70);
          ctx.rotate(ang+arc/2 + Math.PI);
          ctx.font="900 16px Nunito";
          const text = String(n);
          ctx.fillText(text, -ctx.measureText(text).width/2, 0);
          ctx.restore();
        });

        ctx.beginPath();
        ctx.arc(cx,cy,52,0,Math.PI*2);
        ctx.fillStyle="white";
        ctx.fill();
        ctx.lineWidth=6;
        ctx.strokeStyle="rgba(0,0,0,0.15)";
        ctx.stroke();

        ctx.fillStyle="rgba(0,0,0,0.7)";
        ctx.font="900 18px Nunito";
        ctx.fillText("QUAY", cx-ctx.measureText("QUAY").width/2, cy+6);
      }

      window.spinWheel = function(){
        if(!wNames.length) return;
        if(audio){ audio.currentTime = 0; audio.play().catch(()=>{}); }

        let spinTimeTotal = Math.random()*2200 + 4200;
        let spinTime = 0;
        let spinAng = 28;

        function rot(){
          spinTime += 30;
          if(spinTime >= spinTimeTotal){
            const deg = startAng*180/Math.PI + 90;
            const idx = Math.floor((360 - (deg % 360)) / (arc*180/Math.PI)) % wNames.length;
            if(audio) audio.pause();
            showWinner(wNames[idx], "üé°");
            return;
          }
          startAng += (spinAng - (spinAng*(spinTime/spinTimeTotal))) * Math.PI/180;
          drawWheel();
          setTimeout(rot, 30);
        }
        rot();
      };

      function showWinner(n, a){
        const isImg = (a||"").length>50;
        $('winnerDisplay').innerHTML = isImg
          ? `<img src="${a}" style="height:150px;border-radius:50%;object-fit:cover;border:6px solid rgba(0,0,0,.1)">`
          : `<span style="font-size:110px">${escapeHtml(a||"üéâ")}</span>`;
        $('winnerName').innerText = n || "";
        $('winnerModal').style.display='flex';
      }
      window.showWinner = showWinner;

      /* ===================== BOOT ===================== */
      function initDashboard(){
        renderTeacher();
        updateClassSelects();
        renderDashboard();
        renderFeatured();
        setupAvatarSelect();
      }

      (function boot(){
        try{
          if($('logSort')) $('logSort').value = 'desc';
          setInputDateTodayIfEmpty();
          initDashboard();
          updateClassSelects();
          renderLogs();

          // ‚úÖ NEW: test tab bootstrap
          if($('testDate') && !$('testDate').value) $('testDate').value = todayISO();
          if($('testWeight')) $('testWeight').value = '1';
          if($('testClass')) { /* select populated via updateClassSelects */ }
          if($('testStudent')) $('testStudent').innerHTML = `<option value="">-- Ch·ªçn h·ªçc sinh --</option>`;

        }catch(e){
          console.error(e);
          alert("C√≥ l·ªói JS khi kh·ªüi ƒë·ªông. M·ªü Console (F12) ƒë·ªÉ xem chi ti·∫øt.");
        }
      })();

    })();
  </script>

  <!-- ‚úÖ OVERRIDES: tinh t·∫ø ho√° tab Ki·ªÉm Tra + nh·ªè l·∫°i th·∫ª h·ªçc sinh (1 h√†ng ~ 5 b√©) -->
  <style>
    /* 1) ƒê·∫°i s·∫£nh: 1 h√†ng 5 b√© (desktop), responsive xu·ªëng d·∫ßn */
    .student-grid{
      grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
      gap: 18px !important;
      margin-top: 18px !important;
    }
    @media (max-width: 1300px){
      .student-grid{ grid-template-columns: repeat(4, minmax(0, 1fr)) !important; }
    }
    @media (max-width: 1050px){
      .student-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)) !important; }
    }
    @media (max-width: 760px){
      .student-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
    }
    @media (max-width: 480px){
      .student-grid{ grid-template-columns: 1fr !important; }
    }

    /* thu nh·ªè card cho d·ªÖ qu·∫£n l√Ω */
    .card{
      height: 380px !important;
      padding: 14px 14px 74px !important;
      border-radius: 22px !important;
      box-shadow: 0 10px 0 rgba(0,0,0,.09) !important;
    }
    .rank-frame{ width:104px !important; height:104px !important; font-size:58px !important; }
    .card-score{ font-size:2.05em !important; margin:8px 0 !important; }
    .stu-name{ margin:8px 0 4px !important; min-height:44px !important; }
    .title-slot{ min-height:50px !important; }

    /* 2) Tab Ki·ªÉm Tra: ph√¢n c·∫•p ch·ªØ tinh t·∫ø h∆°n (kh√¥ng ƒë·ªïi layout) */
    #tab-test .test-wrap{
      border: 2px solid rgba(0,0,0,.18) !important;
      box-shadow: 0 10px 0 rgba(0,0,0,.08) !important;
    }
    #tab-test h2{
      font-size: 2.1em !important;
      letter-spacing: .3px !important;
      text-transform: none !important;
    }
    #tab-test .pill{
      font-size: .9em !important;
      border: 1.5px solid rgba(0,0,0,.14) !important;
      background: rgba(255,255,255,.85) !important;
    }
    #tab-test label{
      font-size: .95em !important;
      letter-spacing: .2px !important;
    }
    #tab-test .form-control{
      font-size: 1em !important;
      border-width: 2px !important;
      border-color: rgba(178,190,195,.9) !important;
      border-radius: 12px !important;
    }
    #tab-test .mini-stat .stat-card{
      border-left-width: 4px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,.04) !important;
    }
    #tab-test table.live-table th{
      font-size: .9em !important;
      letter-spacing: .6px !important;
      padding: 12px !important;
      border-radius: 10px !important;
    }
    #tab-test table.live-table td{
      padding: 10px !important;
      border-radius: 10px !important;
    }
    #tab-test .tag-w{
      font-size: .9em !important;
      border-radius: 999px !important;
      padding: 4px 10px !important;
    }
    /* Kh√¥ng cho text trong n√∫t xu·ªëng h√†ng */
.nav-btn,
.f-subbtn{
  white-space: nowrap;
}

/* N·∫øu n√∫t c·ªßa b·∫°n l√† flex (c√≥ icon + ch·ªØ), ƒë·∫£m b·∫£o kh√¥ng b·ªã √©p xu·ªëng */
.nav-btn{
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

/* Optional: n·∫øu v·∫´n ch·∫≠t, cho ch·ªØ co l·∫°i nh·∫π */
@media (max-width: 520px){
  .nav-btn{ font-size: 0.92em; }
}
/* 1Ô∏è‚É£ Gi·∫£m chi·ªÅu cao t·ªïng c·ªßa card */
.card{
  height: 300px !important;   /* ƒëang ~380 ‚Üí r√∫t g·ªçn */
  padding: 12px 12px 60px !important;
}

/* 2Ô∏è‚É£ Avatar + khung rank g·ªçn l·∫°i */
.rank-frame{
  width: 92px !important;
  height: 92px !important;
  margin-bottom: 6px !important;
}
/* 3Ô∏è‚É£ T√™n + l·ªõp s√°t nhau h∆°n */
.stu-name{
  margin: 6px 0 2px !important;
  min-height: unset !important;
}
/* 4Ô∏è‚É£ ƒêi·ªÉm s·ªë b·ªõt chi·∫øm ch·ªó */
.card-score{
  font-size: 1.9em !important;
  margin: 4px 0 !important;
}
/* 5Ô∏è‚É£ Kh·ªëi danh hi·ªáu (üåü + ng√†y) n√©n l·∫°i */
.title-slot{
  min-height: 42px !important;
  margin-top: 4px !important;
}
.title-slot div{
  line-height: 1.25 !important;
}
/* 6Ô∏è‚É£ D√≤ng ng√†y kh√¥ng r·ªõt + g·ªçn */
.title-slot > div:last-child{
  white-space: nowrap;
  font-size: 0.78em !important;
}
/* 7Ô∏è‚É£ Thanh icon d∆∞·ªõi ƒë√°y s√°t l√™n */
.card-actions{
  bottom: 10px !important;
}
/* ƒê·∫©y to√†n b·ªô th·∫ª h·ªçc sinh xu·ªëng nh·∫π */
.student-grid{
  margin-top: 40px !important;
}
/* ===================== CHRISTMAS THEME (CSS ONLY) ===================== */

/* 1) Palette Gi√°ng sinh */
:root{
  --xmas-red:#e53935;
  --xmas-green:#1e8e3e;
  --xmas-gold:#f4c542;
  --xmas-ice:#e8f4ff;
  --xmas-night:#0b1b2b;
}

/* 2) N·ªÅn: s·ªçc nh·∫π + glow tuy·∫øt */
body{
  background:
    radial-gradient(circle at 20% 10%, rgba(255,255,255,.85), rgba(255,255,255,0) 45%),
    radial-gradient(circle at 80% 20%, rgba(255,255,255,.75), rgba(255,255,255,0) 50%),
    repeating-linear-gradient(45deg, #fffdf4, #fffdf4 40px, #fff5d6 40px, #fff5d6 80px);
}

/* 3) Navbar: vi·ªÅn candy cane + highlight */
.navbar{
  border-bottom:6px solid transparent !important;
  background:
    linear-gradient(#ffffff,#ffffff) padding-box,
    repeating-linear-gradient(90deg, var(--xmas-red) 0 16px, #ffffff 16px 32px, var(--xmas-green) 32px 48px) border-box !important;
  box-shadow:0 14px 28px rgba(0,0,0,.10) !important;
}

/* 4) Ti√™u ƒë·ªÅ: chuy·ªÉn sang ƒë·ªè-xanh-gold */
.brand-text{
  color:var(--xmas-red) !important;
  text-shadow:3px 3px 0 rgba(0,0,0,.25) !important;
}
.mega-title{
  background:linear-gradient(to right, var(--xmas-red), var(--xmas-gold), var(--xmas-green)) !important;
  -webkit-background-clip:text !important;
  color:transparent !important;
}

/* 5) N√∫t tab: Xmas active */
.nav-btn{
  border-color:rgba(0,0,0,.55) !important;
}
.nav-btn.active{
  background:linear-gradient(135deg, var(--xmas-red), var(--xmas-green)) !important;
  border-color:rgba(0,0,0,.25) !important;
  box-shadow:0 5px 0 rgba(0,0,0,.25) !important;
}

/* 6) C√°c khung ch√≠nh: ‚Äúfrosted glass‚Äù nh·∫π cho tinh t·∫ø */
.dash-controls,
.test-wrap,
#tab-input > div,
#tab-report .report-body > div,
.featured-wrapper{
  backdrop-filter: blur(6px);
}

/* 7) Card h·ªçc sinh: vi·ªÅn + √°nh v√†ng nh·∫π */
.card{
  background:
    radial-gradient(circle at 50% 0%, rgba(244,197,66,.18), rgba(255,255,255,0) 55%),
    linear-gradient(#ffffff,#fafafa) !important;
  border:5px solid rgba(0,0,0,.08) !important;
  box-shadow:0 14px 0 rgba(0,0,0,.08) !important;
}

/* 8) ‚Äúƒê√®n nh√°y‚Äù tr√™n title-banner / header c·ªßa v√≤ng quay (nh·∫π th√¥i) */
.title-banner{
  position:relative;
  overflow:hidden;
}
.title-banner::before{
  content:"";
  position:absolute; inset:-20px;
  background:
    radial-gradient(circle, rgba(229,57,53,.9) 0 4px, transparent 5px) 0 0/40px 40px,
    radial-gradient(circle, rgba(30,142,62,.9) 0 4px, transparent 5px) 20px 20px/40px 40px,
    radial-gradient(circle, rgba(244,197,66,.9) 0 4px, transparent 5px) 10px 30px/50px 50px;
  opacity:.25;
  filter: blur(.2px);
  animation:xmasTwinkle 3.2s ease-in-out infinite;
  pointer-events:none;
}
@keyframes xmasTwinkle{
  0%,100%{opacity:.18;}
  50%{opacity:.33;}
}

/* 9) Tuy·∫øt r∆°i (CSS pseudo overlay) */
body::before, body::after{
  content:"";
  position:fixed; inset:-200px 0 0 0;
  pointer-events:none;
  z-index:9999;
  background-image:
    radial-gradient(circle, rgba(255,255,255,.9) 0 2px, transparent 3px),
    radial-gradient(circle, rgba(255,255,255,.8) 0 1.5px, transparent 3px),
    radial-gradient(circle, rgba(255,255,255,.7) 0 1px, transparent 3px);
  background-size: 120px 120px, 180px 180px, 240px 240px;
  background-position: 0 0, 60px 40px, 120px 80px;
  opacity:.40;
  filter: blur(.2px);
  animation:snowFall 12s linear infinite;
}
body::after{
  opacity:.22;
  filter: blur(.5px);
  animation-duration: 18s;
}
@keyframes snowFall{
  from{ transform: translateY(-120px); }
  to{ transform: translateY(420px); }
}

/* 10) Nh·∫•n m√†u cho pill/tag trong tab Ki·ªÉm Tra */
.pill{ border-color: rgba(0,0,0,.10) !important; }
.tag-w{
  background: rgba(244,197,66,.18) !important;
  border-color: rgba(244,197,66,.35) !important;
}

/* 11) N√∫t OK / Danger / Info theo t√¥ng Noel */
.btn-ok{
  background: linear-gradient(135deg, var(--xmas-red), var(--xmas-green)) !important;
  border-color: rgba(0,0,0,.12) !important;
}
.btn-danger{
  background: var(--xmas-red) !important;
  border-color: var(--xmas-red) !important;
}
.btn-info{
  background: #2b6cb0 !important;
  border-color: #2b6cb0 !important;
}
/* n·ªÅn cute: s·ªçc + gradient ·∫•m */
body{
  background:
    radial-gradient(circle at 15% 10%, rgba(255,255,255,.9), rgba(255,255,255,0) 45%),
    radial-gradient(circle at 85% 20%, rgba(255,255,255,.75), rgba(255,255,255,0) 55%),
    repeating-linear-gradient(45deg,#fffdf6,#fffdf6 36px,#fff1cf 36px,#fff1cf 72px) !important;
}
/* ===== LOGO: ƒë·ªôi m≈© Noel ===== */
.brand-area{ position:relative; }
.brand-logo{ position:relative; z-index:2; }

.brand-area::before{
  content:"üéÖ";
  position:absolute;
  left:58px; top:-12px;
  transform: rotate(-12deg);
  font-size:44px;
  filter: drop-shadow(0 6px 0 rgba(0,0,0,.12));
  z-index:3;
  pointer-events:none;
}
/* sticker ng·∫´u nhi√™n (nh·∫π, cute) */
.card::after{
  content:"üç¨";
  position:absolute;
  top:-16px; left:12px;
  font-size:26px;
  transform: rotate(-10deg);
  filter: drop-shadow(0 6px 0 rgba(0,0,0,.12));
  opacity:.95;
  pointer-events:none;
}
.card:nth-child(3n)::after{ content:"üßÅ"; }
.card:nth-child(3n+1)::after{ content:"üç≠"; }
.card:nth-child(5n)::after{ content:"ü¶å"; }
.card:nth-child(7n)::after{ content:"üéÅ"; }
/* ===== TEACHER CARD: HO√ÄNH TR√ÅNG, KH√îNG ƒêEN X√å ===== */
.teacher-card{
  background:
    radial-gradient(circle at 20% 15%, rgba(255,255,255,.85), rgba(255,255,255,0) 45%),
    radial-gradient(circle at 80% 25%, rgba(255,209,102,.55), rgba(255,209,102,0) 55%),
    linear-gradient(135deg, #f7ffc9 0%, #f9f0f0 55%, #f6b3b3 110%) !important;
  border:6px solid rgba(255,255,255,.75) !important;
  box-shadow: 0 18px 30px rgba(0,0,0,.18), 0 0 0 6px rgba(255,209,102,.25) !important;
}

/* tia s√°ng ‚Äús√¢n kh·∫•u‚Äù */
.teacher-card::before{
  background:
    repeating-conic-gradient(from 0deg,
      rgba(255,255,255,.00) 0 18deg,
      rgba(255,255,255,.18) 18deg 30deg) !important;
  opacity:.55 !important;
  filter: blur(.2px);
}

/* sparkle/tuy·∫øt l·∫•p l√°nh l·ªõp ph·ªß */
.teacher-card::after{
  content:"";
  position:absolute; inset:-10%;
  background:
    radial-gradient(circle, rgba(255,255,255,.95) 0 2px, transparent 3px) 0 0/90px 90px,
    radial-gradient(circle, rgba(255,255,255,.85) 0 1.5px, transparent 3px) 40px 30px/120px 120px,
    radial-gradient(circle, rgba(255,209,102,.75) 0 2px, transparent 4px) 20px 60px/160px 160px;
  opacity:.35;
  animation: teacherSpark 6s linear infinite;
  pointer-events:none;
  z-index:2;
}
@keyframes teacherSpark{
  from{ transform: translateY(-10px); }
  to{ transform: translateY(30px); }
}

/* avatar vi·ªÅn v√†ng n·ªïi h∆°n */
.universe-frame{
  border:6px solid rgba(255,209,102,.95) !important;
  box-shadow:0 12px 0 rgba(0,0,0,.14), 0 0 0 6px rgba(255,255,255,.35) !important;
}

/* badge ‚Äúk·∫ª n·∫Øm gi·ªØ v≈© tr·ª•‚Äù s√°ng & cute h∆°n */
.universe-badge{
  background: linear-gradient(135deg, #f8e8c4, #ebbef0) !important;
  color:#2b2b2b !important;
  border:2px dashed rgba(0,0,0,.18);
}

/* t√™n r·∫°p tr∆∞·ªüng n·ªïi b·∫≠t, b·ªõt t·ªëi */
#tNameDisplay{
  color:#ffffff !important;
  text-shadow: 0 6px 18px rgba(249, 0, 0, 0.35), 2px 2px 0 rgba(245, 5, 5, 0.958) !important;
}
/* ================= NOEL CUTE: ACTIVE TAB + LIGHTS ON MENU ================= */

/* 1) D√ÇY ƒê√àN NH√ÅY ch·∫°y d·ªçc thanh menu */
.nav-menu{
  position:relative;
  padding-top:35px;              /* ch·ª´a ch·ªó treo ƒë√®n */
}

.nav-menu::before{
  content:"";
  position:absolute;
  left:0; right:0; top:0;
  height:18px;
  background:
    /* d√¢y ƒëi·ªán */
    linear-gradient(to right, rgba(0,0,0,.35), rgba(0,0,0,.35)) 0 6px/100% 3px no-repeat,
    /* b√≥ng ƒë√®n */
    radial-gradient(circle, rgba(255,209,102,.95) 0 5px, transparent 6px) 0 12px/46px 18px repeat-x,
    radial-gradient(circle, rgba(255,59,59,.95) 0 5px, transparent 6px) 16px 12px/46px 18px repeat-x,
    radial-gradient(circle, rgba(25,179,107,.95) 0 5px, transparent 6px) 32px 12px/46px 18px repeat-x,
    radial-gradient(circle, rgba(90,209,255,.95) 0 5px, transparent 6px) 48px 12px/46px 18px repeat-x;
  filter: drop-shadow(0 4px 0 rgba(0,0,0,.10));
  opacity:.95;
  animation:xmasLightsTwinkle 2.1s ease-in-out infinite;
  pointer-events:none;
  z-index:3;
}

@keyframes xmasLightsTwinkle{
  0%,100%{ opacity:.88; filter: drop-shadow(0 4px 0 rgba(0,0,0,.10)) brightness(1); }
  50%{ opacity:1; filter: drop-shadow(0 6px 0 rgba(0,0,0,.12)) brightness(1.15); }
}

/* 2) TAB ACTIVE th√†nh "K·∫∏O NOEL" */
.nav-btn.active{
  color:#070707 !important;
  border-color:rgba(0,0,0,.25) !important;
  box-shadow:0 5px 0 rgba(0,0,0,.25) !important;

  /* n·ªÅn k·∫πo: s·ªçc ƒë·ªè-tr·∫Øng-xanh + glow v√†ng */
  background:
    radial-gradient(circle at 20% 30%, rgba(255,209,102,.45), rgba(255,209,102,0) 55%),
    repeating-linear-gradient(135deg,
      #ff3b3b 0 10px,
      #ffffff 10px 20px,
      #19b36b 20px 30px,
      #ffffff 30px 40px) !important;

  position:relative;
  overflow:hidden;
}

/* sparkle nh·ªè trong tab active */
.nav-btn.active::after{
  content:"";
  position:absolute;
  inset:-30%;
  background:
    radial-gradient(circle, rgba(255,255,255,.95) 0 2px, transparent 3px) 0 0/70px 70px,
    radial-gradient(circle, rgba(255,209,102,.9) 0 2px, transparent 4px) 25px 35px/110px 110px;
  opacity:.35;
  animation:tabSpark 3.6s linear infinite;
  pointer-events:none;
}
@keyframes tabSpark{
  from{ transform: translateX(-10px) rotate(0deg); }
  to{ transform: translateX(10px) rotate(360deg); }
}
/* ================= iPad / Tablet Fix Pack ================= */

/* 1) Viewport-fit cho iPhone/iPad tai th·ªè + full safe area */
@supports (padding: max(0px)) {
  body { padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }
}

/* 2) Navbar g·ªçn l·∫°i tr√™n iPad */
@media (max-width: 1024px){
  .navbar{ padding: 12px 14px !important; gap: 12px !important; }
  .brand-logo{ height: 76px !important; border-width:3px !important; }
  .brand-text{ font-size: 2.1em !important; letter-spacing: 1px !important; }
}

/* 3) Menu tab: cho tr∆∞·ª£t ngang (kh√¥ng r·ªõt h√†ng), thao t√°c m∆∞·ª£t tr√™n iOS */
@media (max-width: 1024px){
  .nav-menu{
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px;
    scrollbar-width: none;
  }
  .nav-menu::-webkit-scrollbar{ display:none; }
  .nav-btn{ flex: 0 0 auto; }
}

/* 4) Khu ‚Äúƒê·∫°i s·∫£nh‚Äù c√¢n l·∫°i t·ªâ l·ªá tr√™n iPad */
@media (max-width: 1024px){
  .special-section{ grid-template-columns: 1fr 1.6fr !important; gap: 16px !important; }
  .teacher-card, .featured-wrapper{ min-height: 240px !important; }
}

/* 5) B·∫£ng trong tab Nh·∫≠t k√Ω / Ki·ªÉm tra: iPad cho cu·ªôn ngang m·ªÅm */
@media (max-width: 1024px){
  .live-table{ min-width: 860px !important; }
  #tab-test table.live-table{ min-width: 860px !important; }
}

/* 6) Hover tr√™n iPad hay ‚Äúk·∫πt‚Äù: gi·∫£m hi·ªáu ·ª©ng hover m·∫°nh */
@media (hover: none){
  .card:hover{ transform:none !important; }
  .icon-btn:hover{ transform:none !important; }
}
/* ===================== iPad: g·ªçn header + menu cu·ªôn ngang + layout tho√°ng ===================== */
@media (max-width: 1024px){

  /* 1) HEADER g·ªçn l·∫°i */
  .navbar{
    padding: 8px 12px !important;
    gap: 10px !important;
  }
  .brand-logo{ height: 64px !important; }
  .brand-text{ font-size: 1.85em !important; }

  /* 2) MENU: KH√îNG WRAP -> cho CU·ªòN NGANG ƒë·ªÉ kh·ªèi chi·∫øm 2 h√†ng */
  .nav-menu{
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
    -webkit-overflow-scrolling: touch;
    gap: 8px !important;
    padding-top: 12px !important; /* v·∫´n ch·ª´a ch·ªó treo ƒë√®n */
  }
  .nav-menu::-webkit-scrollbar{ height: 0px; }

  .nav-btn{
    flex: 0 0 auto !important;
    padding: 9px 12px !important;
    font-size: .92em !important;
    border-width: 2px !important;
  }

  /* 3) Container + kho·∫£ng c√°ch chung g·ªçn */
  .container{
    margin: 14px auto !important;
    padding: 0 12px !important;
  }

  /* 4) Tab KI·ªÇM TRA: √©p 1 c·ªôt cho tho√°ng */
  .test-grid{
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }

  /* mini stat nh·ªè g·ªçn h∆°n */
  .mini-stat{
    grid-template-columns: repeat(3, minmax(0,1fr)) !important;
    gap: 8px !important;
  }
  .mini-stat .stat-card{ padding: 10px !important; }
  .mini-stat .stat-val{ font-size: 1.5em !important; }

  /* form g·ªçn l·∫°i */
  .form-control{
    padding: 10px !important;
    font-size: 1em !important;
    border-width: 2px !important;
  }

  /* b·∫£ng ƒë·ª° ‚Äúph√¨nh‚Äù */
  .live-table th{ padding: 10px !important; font-size: .9em !important; }
  .live-table td{ padding: 8px !important; }

  /* 5) Dashboard: card b·ªõt cao ƒë·ªÉ ƒë·ª° ‚Äúd√†i‚Äù */
  .card{
    height: 310px !important;
    padding: 12px 12px 54px !important;
  }
}

/* iPad portrait nh·ªè h∆°n: gi·∫£m ch·ªØ th√™m x√≠u */
@media (max-width: 834px){
  .brand-text{ font-size: 1.6em !important; }
  .nav-btn{ font-size: .9em !important; padding: 8px 11px !important; }
}
  </style>
</body>
</html>
